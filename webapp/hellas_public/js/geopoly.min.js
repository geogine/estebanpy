!function(e,n){"object"==typeof exports&&"object"==typeof module?module.exports=n():"function"==typeof define&&define.amd?define([],n):"object"==typeof exports?exports.geopoly=n():e.geopoly=n()}(this,(function(){return function(e){var n={};function t(o){if(n[o])return n[o].exports;var i=n[o]={i:o,l:!1,exports:{}};return e[o].call(i.exports,i,i.exports,t),i.l=!0,i.exports}return t.m=e,t.c=n,t.d=function(e,n,o){t.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:o})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,n){if(1&n&&(e=t(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(t.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var i in e)t.d(o,i,function(n){return e[n]}.bind(null,i));return o},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},t.p="",t(t.s=4)}([function(e,n,t){"use strict";t.d(n,"b",(function(){return o})),t.d(n,"c",(function(){return r})),t.d(n,"a",(function(){return s})),t.d(n,"j",(function(){return a})),t.d(n,"e",(function(){return d})),t.d(n,"d",(function(){return c})),t.d(n,"g",(function(){return u})),t.d(n,"h",(function(){return p})),t.d(n,"f",(function(){return f})),t.d(n,"i",(function(){return h}));let o={},i={},r={lumberyard:{disabled:!0,cat:"eco",type:"booster",cat_color:"green",cat_bg:"bg-success"},stonemason:{disabled:!1,cat:"eco",type:"booster",cat_color:"green",cat_bg:"bg-success"},foundry:{disabled:!0,cat:"eco",type:"booster",cat_color:"green",cat_bg:"bg-success"},mill:{disabled:!0,cat:"eco",type:"booster",cat_color:"green",cat_bg:"bg-success"},warehouse:{disabled:!1,cat:"eco",type:"storage",cat_color:"green",cat_bg:"bg-success"},granary:{disabled:!1,cat:"eco",type:"storage",cat_color:"green",cat_bg:"bg-success"},harbor:{disabled:!0,cat:"eco",type:"trading",cat_color:"green",cat_bg:"bg-success"},acropolis:{disabled:!1,cat:"infra",type:null,cat_color:"blue",cat_bg:"bg-primary"},agora:{disabled:!1,cat:"infra",type:null,cat_color:"blue",cat_bg:"bg-primary"},theatre:{disabled:!1,cat:"infra",type:null,cat_color:"blue",cat_bg:"bg-primary"},temple:{disabled:!0,cat:"infra",type:null,cat_color:"blue",cat_bg:"bg-primary"},house:{disabled:!0,cat:"infra",type:null,cat_color:"blue",cat_bg:"bg-primary"},road:{disabled:!1,cat:"infra",type:null,cat_color:"blue",cat_bg:"bg-primary"},gymnasium:{disabled:!1,cat:"mil",type:"training",cat_color:"red",cat_bg:"bg-danger"},wall:{disabled:!0,cat:"mil",type:"defensive",cat_color:"red",cat_bg:"bg-danger"}};const s={lumberyard:"wood",stonemason:"limestone",foundry:"bronze",mill:"food"},a={wood:{name:"Forest",bg:"bg-success"},limestone:{name:"Limestone mine",bg:"bg-secondary"},marble:{name:"Marble mine",bg:"bg-white progress-bar-striped"},food:{name:"Wheat fields",bg:"bg-danger"},bronze:{name:"Copper mine",bg:"bg-copper bg-copper progress-bar-striped"},gold:{name:"Taxation",bg:"bg-warning"}};fetch("/json/buildings.json",{cache:"force-cache"}).then(e=>e.json()).then(e=>{o=e.costs,i=e.build_tree,Events.fire("load_game_conf",[])});const l=new Set(["wood","gold","limestone","marble"]);function d(e,n){const t={},i=n;if(!o[e])return console.error("Bid not found",e),{};for(let n of l){if(!o[e][n])continue;const r=o[e][n][i-1];r>0&&(t[n]=r)}return 0==len(t)?null:t}function c(e,n,t){if("number"==typeof n||!isNaN(parseInt(n))){let i=parseInt(n);n=e.gatherers[i][0];if(!t)t=e.gatherers[i][1];return function(e,n,t){const i=t+1;if(!o[n].wood[i-1])return!1;for(let t of l){const r=o[n][t][i-1];if(e.resources[t]<r)return!1}return!0}(e,n,t)}if(r[n].disabled)return!1;const i=t||(e.buildings[n]||0)+1;if(!o[n].wood[i-1])return!1;for(let t of l){const r=o[n][t][i-1];if(e.resources[t]<r)return!1}return!0}function u(e){let n=[];for(let[t,o]of Object.items(i)){if(e.buildings[t])continue;if("road"==t)continue;if(r[t].disabled)continue;let i=!0;for(let[n,t]of o)(e.buildings[n]||0)<t&&(i=!1);i&&n.push(t)}return n}function p(e){let n=[];for(let[t,o]of Object.items(i)){if(e.buildings[t])continue;if("road"==t)continue;if(r[t].disabled)continue;let i=[t,[]],s=0;for(let[n,t]of o)s+=Math.max(0,t-(e.buildings[n]||0)),i[1].push([n,t]);s/len(i[1])<=2.4&&0!=s&&n.push(i)}return n}function f(e){let n=[];for(let[e,t]of Object.items(i))"road"!=e&&(r[e].disabled||n.push(e));return n}function h(e,n){let t;t=isNaN(parseInt(n))?d(n,e.buildings[n]):d(e.gatherers[n][0],e.gatherers[n][1]);for(let[n,o]of Object.items(t))e.resources[n]-=o}},function(e,n,t){"use strict";t.d(n,"d",(function(){return c})),t.d(n,"c",(function(){return u})),t.d(n,"b",(function(){return p})),t.d(n,"e",(function(){return f})),t.d(n,"a",(function(){return h}));var o=t(0);const i={wood:"lumberyard",limestone:"stonemason",bronze:"foundry",food:"mill",gold:"agora",marble:"__nothing__"},r=1,s=11e3,a=1e5,l=30,d=.9;function c(e,n){if("gold"==n)return u(e,n,1);let t=0;for(let[o,i]of e.gatherers)o==n&&(t+=u(e,o,i));return t}function u(e,n,t){if(t<=0)return 0;let s=1,a=i[n]||null;if(a in e.buildings){let n=e.buildings[a];n>0&&(s=1+o.b[a].attri[n-1]/100)}return"gold"==n?s*e.resources.pop*d*r:o.b[n].prod[t-1]*s*r}function p(e,n){if("holy"==n)return l;if("emerald"==n)return a;if("pop"==n)return s;let t="warehouse";"food"==n&&(t="granary");let i=e.buildings[t]||0;return 0==i?0:o.b[t].attri[i-1]}function f(e,n){const t=n/3600;return e.resources.wood+=Math.min(p(e,"wood"),c(e,"wood")*t),e.resources.food+=Math.min(p(e,"food"),c(e,"food")*t),e.resources.gold+=Math.min(p(e,"gold"),c(e,"gold")*t),e.resources.marble+=Math.min(p(e,"marble"),c(e,"marble")*t),e.resources.bronze+=Math.min(p(e,"bronze"),c(e,"bronze")*t),e.resources.limestone+=Math.min(p(e,"limestone"),c(e,"limestone")*t),!0}function h(e){return e>=1e6?5:e>=1e5?4:e>=5e3?3:e>=200?2:1}},function(e,n,t){"use strict";t.d(n,"a",(function(){return o}));let o={},i={};$("#app-gui").innerHTML&&(o=new Vue({el:"#app-gui",data:{opened_comp:null,opened:null,opened_type:null,infobar_lastpos:defaultdict(list,!0)},methods:{child:function(e){return this.$refs[e]},infobar:function(e,...n){this.opened_comp&&"infobar"!=this.opened_type&&(this.opened_comp.show=!1,this.opened=null,this.opened_type=null);let t=this.$refs["infobar-"+e];if(t){if(t.open(...n),t.show=!0,this.opened_comp=t,this.opened=e,this.opened_type="infobar",o.infobar_lastpos[o.opened]){const[e,n]=o.infobar_lastpos[o.opened];Vue.nextTick(()=>{t.$el.style.left=e+"px",t.$el.style.top=n+"px"})}return t}},dialog:function(e,...n){this.opened_comp&&"infobar"!=this.opened_type&&(this.opened_comp.show=!1,this.opened=null,this.opened_type=null);let t=this.$refs["dialog-"+e];if(t)return t.open(...n),t.show=!0,this.opened_comp=t,this.opened=e,this.opened_type="dialog",t},overlay:function(e,n,...t){this.opened_comp&&"infobar"!=this.opened_type&&(i[this.opened]&&i[this.opened].setPosition(void 0),this.opened_comp.show=!1,this.opened=null,this.opened_type=null);let r=this.$refs["overlay-"+e];if(r){if(r.open(...t),r.show=!0,this.opened_comp=r,this.opened=e,this.opened_type="overlay",i[e])i[e].setPosition(n);else{const t=new ol.Overlay({element:o.$refs["overlay-"+e].$el,position:n,autoPan:!0,autoPanAnimation:{duration:250}});map.addOverlay(t),i[e]=t}return r}},flash:function(e,n,t){this.$refs.flash.display(e,n,t)},quit:function(e){if(e){const n=this.$refs[e];if(!n)return void console.error("Trying to close unknown gui element",e);n.close?n.close():n.show=!1}else for(let e in this.$refs)this.quit(e);(this.opened_comp||this.opened)&&(this.opened_comp=null,this.opened=null)}},computed:{frame:function(){return this.$refs.frame}}}))},function(e,n,t){"use strict";const o={not_found:new Color(0,255,255),black:new Color(0,0,0),white:new Color(255,255,255),mil_mark:new Color(150,150,150),exhausted:new Color(40,58,64),base:new Color([211,191,158]),base_edge:new Color([99,84,58])},i={AA:o.base},r=new Set([]);let s={colorscheme:"softlight"};function a(e){if("string"==typeof e)e={iso:e};else if(e.getProperties)e=e.getProperties();let n=e.iso;return n?i[n]?r.has(n)&&["softlight","hardlight"].includes(s.colorscheme)?i[n].blend(o.base,"multiply"):"inverted"==s.colorscheme?i[n].blend(o.base,"multiply"):i[n]:o.not_found:o.base}const l=new Set([]),d={w:512,h:512};let c=document.createElement("canvas");c.width=d.w,c.height=d.h;c.getContext("2d");let u=[0,0],p=!1;Vue.mixin({methods:{open_dialog:function(e,...n){gui.dialog(e,...n)},open_infobar:function(e,...n){gui.infobar(e,...n)},close_infobar:function(e){gui.$refs["infobar-"+e]&&gui.$refs["infobar-"+e].onclose&&gui.$refs["infobar-"+e].onclose(),gui.quit("infobar-"+e)},infobar_mousedown:function(e){const n=e.target.parentElement;"infobar "==n.className.substr(0,8)&&(p=!0,u=[n.offsetLeft-e.clientX,n.offsetTop-e.clientY])},infobar_mouseup:function(e){p=!1},infobar_mousemove:function(e,n){if(e.preventDefault(),p){const t=e.target.parentElement,o=e.clientX+u[0],i=e.clientY+u[1];t.style.left=o+"px",t.style.top=i+"px",gui.infobar_lastpos[n]=[o,i]}},maxHeight:function(){return"max-height: "+($("#app-map").offsetHeight-220)+"px;"},area_color:function(e){return"color: "+a(e).contrast()+";"},area_background:function(e){var n=a(e);return"background: "+n.rgba()+";"+("color: "+n.contrast()+";")},unit_background:function(e){let n=a(e);for(;"black"==n.contrast();)n=n.shade(-.15);return"background: "+n.rgba()+";"+("color: "+n.contrast()+";")},herald:function(e){let n;if(n="string"==typeof e?e:e.get||e.getProperties?e.get("iso"):e.iso,l.has(n))var t="background-image: "+("url('/img/flags/flag_"+n+".png')")+";background-position:center;";else t="background-color: "+a(e).rgb()+";";return t}}})},function(e,n,t){"use strict";t.r(n);Vue.component("infobar-header",{template:'\n\n\n  <div @mousedown="infobar_mousedown" @mouseup="infobar_mouseup" @mousemove="infobar_mousemove($event, infobar_id)" class="infobar-header unselectable" :style="iso ? area_background(iso) : \'\'">\n    <div v-if="iso" :class="\'border border-dark rounded d-inline-block flag flag-xs flag-\'+iso"></div>\n\n    {{ content }}\n\n    <span v-if="subcontent" class="small">{{ subcontent }}</span>\n\n    <button type="button" class="close" aria-label="Close" @click="close_infobar(infobar_id)">\n      <span aria-hidden="true">&times;</span>\n    </button>\n  </div>\n\n',props:{content:{default:""},subcontent:{default:""},iso:{default:null},infobar_id:{default:""}}});var o=t(0),i=t(1);let r=3e5,s=500,a=null;function l(e){a=e;setInterval(()=>{fetch("/api/town/resources").then(e=>e.json()).then(e=>{a.resources=e})},r);let n=(new Date).getTime();setInterval(()=>{let e=(new Date).getTime(),t=(e-n)/1e3;Object(i.e)(a,t),n=e},s)}function d(e,n,t,i){const r=new FormData;if(t){if(e.buildings[n])return void console.error("New building called with existing bid",n);r.append("x",t[0]),r.append("y",t[1]),fetch("/api/town/build/"+n,{method:"POST",body:r}).then(e=>e.json()).then(t=>{if(t.error)return c(t);e.buildings[n]=1,Object(o.i)(e,n),i()})}else{if(!e.buildings[n]&&!e.gatherers[parseInt(n)])return void console.error("Building or gatherer doesn't exist",n);fetch("/api/town/build/"+n,{method:"PUT",body:r}).then(e=>e.json()).then(t=>{if(t.error)return c(t);if(isNaN(parseInt(n))){e.buildings[n]+=1;e.buildings[n];i()}else{e.gatherers[n][1]+=1;e.gatherers[n][1];i&&i()}Object(o.i)(e,n)})}}function c(e){if(e.error)if(Array.isArray(e.error)){let n="";for(let[t,o]of Object.items(e.error[1]))n+=t+" -> "+o+", ";alert(e.error[0]+": "+n)}else alert(e.error)}Vue.component("upgrade-button",{template:'\n\n  <div v-if="get_costs(res_bid, lvl+1)">\n    <span id="btn-tool-wrapper" class="d-inline-block" tabindex="0">\n      <button @click="onSubmit" :disabled="!can_build(town, bid)" class="btn btn-sm btn-danger">Upgrade</button>\n    </span>\n\n    <b-tooltip target="btn-tool-wrapper" custom-class="tooltip-res" placement="bottom">\n      <strong>Costs for lvl {{lvl+1}}:</strong>\n\n      <div v-for="(am,res) in get_costs(res_bid, lvl+1)">\n        <span v-if="res != \'gold\'" :class="\'ra ra-2x ra-res-\'+res"></span> {{ am.estimation() }}\n        <span v-else :class="\'ra ra-2x ra-res-gold\'+goldicon(am)"></span> {{ am.estimation() }}\n      </div>\n    </b-tooltip>\n  </div>\n',props:["town","bid"],data:function(){return{}},created:function(){},methods:{onSubmit:function(){d(this.town,this.bid),Events.fire("build_upgrade",[this.bid,this.town.buildings[this.bid]+1])},goldicon:function(e){return Object(i.a)(e)},get_costs:o.e,can_build:o.d},computed:{is_gatherer:function(){return"number"==typeof this.bid||!isNaN(parseInt(this.bid))},lvl:function(){return this.is_gatherer?this.town.gatherers[parseInt(this.bid)][1]:this.town.buildings[this.bid]},res_bid:function(){return this.is_gatherer?this.town.gatherers[parseInt(this.bid)][0]:this.bid}}});Vue.component("infobar-booster",{template:'\n  <div v-if="show" class="infobar infobar-lg font-oldie">\n    <infobar-header :content="bid.title()" :subcontent="\'lvl \'+town.buildings[bid]"  infobar_id="booster"></infobar-header>\n\n    <div v-if="!show_info" class="infobar-content p-2" :bid="bid">\n\n      <div class="d-flex">\n        <div class="flex-fill">\n          <p><span class="small">Boosts {{ res }} gathering.</span></p>\n\n          <p><span :class="\'ra ra-lg ra-res-\'+res"></span> <b>{{ Math.floor(amount).estimation() }}</b> (+{{ Math.floor(prod_total).estimation() }} / h).</p>\n\n          <span @click="show_info=true" class="ra ra-lg ra-icon-question pointer">\n            <span class="path1"></span><span class="path2"></span><span class="path3"></span>\n          </span>\n        </div>\n\n        <div>\n          <div :class="\'border border-3 border-black res-box text-center mb-1 py-3 \'+resborder">\n            <b>+{{ attri }}%</b>\n          </div>\n          \n          <upgrade-button v-if="world.me == town.iso" :town="town" :bid="bid"></upgrade-button>\n        </div>\n      </div>\n\n    </div>\n    <div v-else class="infobar-content p-2 scroll" :bid="res">\n      <h3 class="font-brand">How boosters work.</h3>\n\n      <p>Booster buildings will give an extra kick to your resource gathering. Wood, limestone, gold and food income can be boosted. The maximum level is only 5 for these buildings.</p>\n\n      <button @click="show_info=false" class="btn btn-link">Back</button>\n    </div>\n  </div>\n',data:function(){return{show:!1,infobar_id:null,show_info:!1,town:null,bid:null,lvl:0,attri:null,amount:0,storage:0,prod_total:0}},methods:{open:function(e,n){this.town=e,this.bid=n,this.lvl=e.buildings[n]||0,this.attri=o.b[n].attri[this.lvl-1],this.res=o.a[n],this.prod_total=Object(i.d)(e,this.res),this.storage=Object(i.b)(e,this.res),this.amount=e.resources[this.res]||-1,this.infobar_id="booster-"+this.res}},computed:{resborder:function(){return o.j[this.res].bg}}});Vue.component("infobar-agora",{template:'\n  <div v-if="show" class="infobar font-oldie">\n    <infobar-header content="Agora" :subcontent="\'lvl \'+town.buildings.agora" infobar_id="agora"></infobar-header>\n\n    <div v-if="!show_info" class="infobar-content p-2" bid="agora">\n\n      <ul>\n        <li>Boosts <span class="ra ra-lg ra-res-gold1"></span> taxation. <b>{{ attri }}%</b> of {{ town.name }}\'s population tributes tax.\n          <span @click="show_info=true" class="ra ra-lg ra-icon-question pointer">\n            <span class="path1"></span><span class="path2"></span><span class="path3"></span>\n          </span>\n        </li>\n        <li>Political and social center of the city state.</li>\n      </ul>\n\n      <upgrade-button v-if="world.me == town.iso" :town="town" bid="agora"></upgrade-button>\n\n      <hr/>\n\n      <div>\n        <button class="btn btn-link" disabled>Politics</button>\n        <button class="btn btn-link" disabled>Diplomacy</button>\n        <button class="btn btn-link" disabled>Open chat</button>\n      </div>\n\n    </div>\n    <div v-else class="infobar-content p-2 scroll" bid="agora">\n      <h3 class="font-brand">How .</h3>\n\n      <p>You .</p>\n\n\n      <button @click="show_info=false" class="btn btn-link">Back</button>\n    </div>\n  </div>\n',data:function(){return{show:!1,infobar_id:null,show_info:!1,town:null,attri:0,res:null,amount:0,storage:0,prod_total:0}},methods:{open:function(e){this.town=e;const n=e.buildings.agora;this.attri=o.b.agora.attri[n-1],this.res="gold",this.prod_total=Object(i.d)(e,this.res),this.storage=Object(i.b)(e,this.res),this.amount=e.resources[this.res]||-1,this.infobar_id="agora"}}});const u=defaultdict(list,!0);let p=null,f=null;function h(e){u[e.name].push(e)}function b(e){let n=u[p],t=u[e];if(n)for(let e of n)e.unregister(Objects.scene);if(t){p=e;for(let e of t)e.register(Objects.scene);console.log("Switched state:",e)}else console.error("State not found:",e)}function g(e){f.target=e.position}h({name:"nil",module:"controls.js",register:function(){},unregister:function(){},pointerMove:null,pointerClick:null});let m=!1;Vue.component("infobar-acropolis",{template:'\n  <div v-if="show" class="infobar">\n    <infobar-header content="Acropolis" :subcontent="\'lvl \'+town.buildings.acropolis" infobar_id="acropolis"></infobar-header>\n\n    <div v-if="!show_info" class="infobar-content p-2" bid="acropolis">\n\n      <div v-if="world.me == town.iso" class="float-right bg-light p-1 rounded-pill border border-danger">\n        <div @click="set_state(\'Moving\')" id="btn-move"  :class="{\'chk-circle border border-primary\': true, \'bg-primary text-white\': state == \'Moving\'}">\n          <span class="ra ra-icon-drag"></span>\n        </div>\n        <div @click="set_state(\'Roading\')" id="btn-road" :class="{\'chk-circle border border-warning\': true, \'bg-warning text-white\': state == \'Roading\'}">\n          <span class="ra ra-icon-road"></span>\n        </div>\n\n        <b-tooltip target="btn-move" placement="left">\n          <b>Replace</b> buildings\n        </b-tooltip>\n        <b-tooltip target="btn-road" placement="left">\n          Add/remove <b>roads</b>\n        </b-tooltip>\n      </div>\n      <p style="font-size: 14px;">Unlocks additional <b>buildings</b> at each level.\n        <span @click="show_info=true" class="ra ra-lg ra-icon-question pointer">\n          <span class="path1"></span><span class="path2"></span><span class="path3"></span>\n        </span>\n\n\n        <upgrade-button v-if="world.me == town.iso" :town="town" bid="acropolis"></upgrade-button>\n\n      </p>\n      \n      <div v-if="new_buildings.length > 0" class="d-flex flex-fill">\n        <div @mousedown="start_leftslide" @mouseup="stop_slide" class="flex-fill align-self-center pointer p-1">\n          <span class="ra ra-2x ra-icon-arrow-left"></span>\n        </div>\n        <div ref="scroller" class="d-flex">\n\n          <div v-for="bid in new_buildings">\n            <div @click="onBuild(bid)" :id="bid" :class="{\'card\': true, \'pointer\': world.me == town.iso}">\n              <div :class="\'card-body \' + build_skins[bid].cat_bg">\n                {{ bid }}\n              </div>\n            </div>\n\n            <b-tooltip :target="bid" placement="bottom">\n              <strong>Cost to build:</strong>\n\n              <div v-for="(am,res) in get_costs(bid, 1)">\n                <span v-if="res != \'gold\'" :class="\'ra ra-2x ra-res-\'+res"></span> {{ am.estimation() }}\n                <span v-else :class="\'ra ra-2x ra-res-gold1\'"></span> {{ am.estimation() }}\n              </div>\n            </b-tooltip>\n          </div>\n\n        </div>\n        <div @mousedown="start_rightslide" @mouseup="stop_slide" class="flex-fill align-self-center pointer p-1">\n          <span class="ra ra-2x ra-icon-arrow-right"></span>\n        </div>\n      </div>\n      <div v-else>\n        <p>There are no new buildings to construct.</p>\n      </div>\n\n\n      <div v-if="upcoming_buildings.length > 0">\n        <hr/>\n        <p>Upcoming buildings:</p>\n\n        <ul class="list-group scroll" style="max-height: 180px;">\n          <li v-for="[bid, reqs] in upcoming_buildings" class="list-group-item">\n            <span :class="\'badge \'+build_skins[bid].cat_bg+\' text-white\'">{{ bid }}</span> - \n            <span><span v-for="[rbid, lvl] in reqs">{{ rbid.title() }} lvl {{ lvl }}, </span></span>\n          </li>\n        </ul>        \n      </div>\n\n    </div>\n    <div v-else class="infobar-content p-2 scroll" bid="acropolis">\n      <h3 class="font-brand">How to use the acropolis.</h3>\n\n      <p>Acropolis is your main building. You can use it to construct new buildings in your town, reposition existing buildings, or to build roads.</p>\n\n      <p>To construct a building, select it from the available list, and place it somewhere on your map.</p>\n\n      <p>When editing roads, make sure you close the Acropolis dialog or untoggle the road editing button before you exit the game, otherwise your roads won\'t be saved!</p>\n\n      <p>Here\'s a list on what you can build:</p>\n\n      <ul>\n        <li v-for="bid in all_buildings"><span v-if="!town.buildings[bid]" class="ra ra-lg ra-icon-build"></span> {{ bid.title() }}</li>\n      </ul>\n\n      <button @click="show_info=false" class="btn btn-link">Back</button>\n    </div>\n  </div>\n',data:function(){return{show:!1,infobar_id:null,show_info:!1,town:null,new_buildings:null,upcoming_buildings:[],all_buildings:[],build_skins:o.c,slide_stop:!1,state:"Default"}},methods:{open:function(e){this.town=e,this.new_buildings=Object(o.g)(e),this.upcoming_buildings=Object(o.h)(e),this.all_buildings=Object(o.f)(e),this.infobar_id="acropolis"},onclose:function(){"Default"!=this.state&&(this.state="Default",b("Default")),Events.fire("set_build",[null])},onBuild:function(e){this.world.me==this.town.iso&&(Events.fire("set_build",[e]),this.state="Building",b("Building"))},start_leftslide:function(){const e=this.$refs.scroller;let n=0,t=o=>{n||(n=o);let i=o-n;n=o,e.scrollLeft>=0&&!this.slide_stop?(e.scrollLeft-=.5*i,window.requestAnimationFrame(t)):this.slide_stop=!1};window.requestAnimationFrame(t)},start_rightslide:function(){const e=this.$refs.scroller;let n=0,t=o=>{n||(n=o);let i=o-n;n=o,e.scrollLeft<=e.scrollWidth&&!this.slide_stop?(e.scrollLeft+=.5*i,window.requestAnimationFrame(t)):this.slide_stop=!1};window.requestAnimationFrame(t)},stop_slide:function(){this.slide_stop=!0},set_state:function(e){this.world.me==this.town.iso&&(e==this.state?(b("Default"),this.state="Default"):(b(e),this.state=e))},can_build:o.d,get_costs:o.e}});Vue.component("infobar-temple",{template:'\n  <div v-if="show" class="infobar infobar-lg font-oldie">\n    <infobar-header content="temple" infobar_id="temple"></infobar-header>\n\n    <div class="infobar-content p-2" :bid="bid">\n\n      <div class="d-flex">\n        <div class="flex-fill">\n        </div>\n      </div>\n\n    </div>\n  </div>\n',data:function(){return{show:!1,infobar_id:null,show_info:!1,town:null,bid:null}},methods:{open:function(e,n){this.town=e,this.bid=n,this.infobar_id="temple"}}});Vue.component("infobar-gymnasium",{template:'\n  <div v-if="show" class="infobar infobar-lg font-oldie">\n    <infobar-header content="Gymnasium"  :subcontent="\'lvl \'+town.buildings.gymnasium" infobar_id="gymnasium"></infobar-header>\n\n    <div v-if="!show_info" class="infobar-content p-2" bid="gymnasium">\n\n      <div class="d-flex">\n        <div class="flex-fill">\n\n          <ul>\n            <li>Find heroes to lead your army!</li>\n            <li>Heroes recruit hoplites to expand your army</li>\n            <li>Heroes come here to train (<b>+{{ attri }} xp</b> per hour)</li>\n          </ul>\n\n          <upgrade-button v-if="world.me == town.iso" :town="town" bid="gymnasium"></upgrade-button>\n        </div>\n\n        <div class="m-2" >\n          <div id="n-heroes" @click="show_info = 2" class="border border-3 border-black py-1 px-2 rounded-top mt-2 pointer" style="background: #7f7f7f">\n            <span class="ra ra-3x ra-item-hoplite"></span> \n            <span style="font-size: 1.8em">{{ heroes.length }}</span>\n          </div>\n          <div id="n-hoplites" class="border border-3 border-top-0 border-black py-1 px-2 rounded-bottom mb-2" style="background: #7f7f7f">\n            <span class="ra ra-lg ra-item-spartan"></span> \n            <span>{{ Math.round(hoplites).estimation() }}</span>\n          </div>\n\n          <b-tooltip target="n-heroes" placement="top">\n            Heroes in your town\n          </b-tooltip>\n          <b-tooltip target="n-hoplites" placement="bottom">\n            Hoplites in your town\n          </b-tooltip>\n        </div>\n      </div>\n    </div>\n    <div v-else-if="show_info == 1" class="infobar-content p-2 scroll" bid="gymnasium">\n      <h3 class="font-brand">Why do I need a gymnasium?</h3>\n\n      <p>You can find new <strong>Heroes</strong>, elite warriors of your City-state in the Gymnasium. Heroes lead your army to battle, but they also recruit more soldiers for you! </p>\n\n      <p>Right now Heroes spend 50% of their time training and the other 50% with recruiting people. In future updates, you\'ll be able to decide this ratio by sending them onto different buildings.</p>\n\n      <h4>Types of soldiers</h4>\n\n      <h4>Maintaining</h4>\n      <p>Heroes and soldiers eat a lot of food, and consume some gold every day. Make sure you never run out of food, otherwise they will start dieing. Not receiving their gold will make them angry and rebel. Heroes who are training inside the gymnasium also consume bronze.</p>\n\n\n      \x3c!-- \n      <p>You can train your Hoplites, Once you have enough strong hoplites, you can send them off to the World Map to conquer some territories or to battle players in your world instance.</p>\n\n      <h4>Training</h4>\n      <p>By sending your hoplites into the gymnasium, they will train and gain xp, leveling up their strength levels. Strength roughly equals to the percentage of health dealt as damage. So a hoplite with 99 strength will technically kill every enemy in 1 hit. But 99 strenght is <b>hard</b> to achieve, even for a single hoplite.</p>\n\n       --\x3e\n\n      <button @click="show_info = 0" class="btn btn-link">Back</button>\n    </div>\n    <div v-else-if="show_info == 2" class="infobar-content p-2 scroll" bid="gymnasium">\n      <h4>Your heroes</h4>\n\n      <p v-if="heroes.length == 0">You do not have any heroes in your city.</p>\n\n      <span id="btn-tool-wrapper" class="d-inline-block" tabindex="0">\n        <button @click="onAddHero" :disabled="true" class="btn btn-sm btn-danger">Find heroes</button>\n      </span>\n\n      <b-tooltip target="btn-tool-wrapper" custom-class="tooltip-res" placement="bottom">\n        <strong>Costs for next hero:</strong>\n\n        <p>TODO</p>\n      </b-tooltip>\n\n    </div>\n  </div>\n',data:function(){return{show:!1,infobar_id:null,show_info:0,town:null,attri:0,heroes:[],hoplites:0,last_query:0}},methods:{open:function(e,n){this.town=e,this.infobar_id="gymnasium";const t=this.town.buildings.gymnasium||0;if(this.attri=o.b.gymnasium.attri[t-1],this.hoplites=this.town.hoplites||0,n)this.heroes=n;else if(0==len(this.heroes)){if(time()-this.last_query<=8)return;fetch("/api/town/heroes").then(e=>e.json()).then(e=>{this.heroes=e,this.last_query=time()})}},onAddHero:function(){!function(e,n,t){if(null==t)t=1;formData.append("num",t),fetch("/api/town/"+n,{method:"POST",body:formData}).then(e=>e.json()).then(e=>{if(e.error)return c(e);alert("OKIE DOKIE")})}(this.town,"hero")}}});Vue.component("infobar-theatre",{template:'\n  <div v-if="show" class="infobar infobar-lg font-oldie">\n    <infobar-header content="Theatre" :subcontent="\'lvl \'+town.buildings.theatre" infobar_id="theatre"></infobar-header>\n\n    <div v-if="!show_info" class="infobar-content p-2" bid="">\n      <p>IT DOESN\'T DO SHIT YET, BUT IT LOOKS FUCKING COOL INNIT</p>\n\n      <span @click="show_info=true" class="ra ra-lg ra-icon-question pointer">\n        <span class="path1"></span><span class="path2"></span><span class="path3"></span>\n      </span>\n\n      <div class="d-flex">\n        <div class="flex-fill">\n        </div>\n      </div>\n\n    </div>\n  </div>\n',data:function(){return{show:!1,infobar_id:null,show_info:!1,town:null}},methods:{open:function(e){this.town=e,this.infobar_id="theatre"}}});Vue.component("infobar-storage",{template:'\n  <div v-if="show" class="infobar font-oldie">\n    <infobar-header :content="bid.title()" :subcontent="\'lvl \'+town.buildings[bid]" infobar_id="storage"></infobar-header>\n\n    <div v-if="!show_info" class="infobar-content p-2" :bid="bid">\n      <div v-if="bid == \'granary\'" style="font-size: 18px;">\n        <span class="ra ra-lg ra-res-food"></span> wheat storage capacity: <b>{{ storage.estimation() }}</b>.\n\n        <span @click="show_info=true" class="ra ra-lg ra-icon-question pointer">\n          <span class="path1"></span><span class="path2"></span><span class="path3"></span>\n        </span>\n      </div>\n      <div v-else style="font-size: 18px;">\n        <span class="ra ra-lg ra-res-gold1"></span> <span class="ra ra-lg ra-res-wood"></span> <span class="ra ra-lg ra-res-limestone"></span> <span class="ra ra-lg ra-res-bronze"></span> material storage capacity: <b>{{ storage.estimation() }}</b>.\n\n        <span @click="show_info=true" class="ra ra-lg ra-icon-question pointer">\n          <span class="path1"></span><span class="path2"></span><span class="path3"></span>\n        </span>\n      </div>\n\n      <upgrade-button v-if="world.me == town.iso" :town="town" :bid="bid"></upgrade-button>\n\n\x3c!--       <hr/>\n      <span>Current resource load:</span>\n      <div class="progress progress-lg">\n        <div class="progress-bar progress-danger" role="progressbar" :style="\'width: \'+ round(amount / storage *100) +\'%\'">{{ round(amount / storage *100) }}%</div>\n      </div> --\x3e\n\n    </div>\n    <div v-else class="infobar-content p-2 scroll" :bid="bid">\n      <h3 class="font-brand">Storage</h3>\n\n      <p>Your Warehouse and your Granary limit the maximum amount of resource you can have. Your gatherers are constantly collecting various resources for you, so you have to make sure your storage capacity is big enough for your empire.</p>\n\n      <button @click="show_info=false" class="btn btn-link">Back</button>\n    </div>\n  </div>\n',data:function(){return{show:!1,infobar_id:null,show_info:!1,town:null,bid:null,lvl:0,amount:0,storage:0,prod:0,prod_total:0}},methods:{open:function(e,n){this.town=e,this.bid=n,this.lvl=e.buildings[n],this.infobar_id="storage";const t="granary"==this.bid?"food":"limestone";this.storage=Object(i.b)(e,t)}}});Vue.component("infobar-gatherer",{template:'\n  <div v-if="show" class="infobar infobar-lg font-oldie">\n    <infobar-header :content="gather_name" :subcontent="\'lvl \'+lvl" infobar_id="gatherer"></infobar-header>\n\n    <div v-if="!show_info" class="infobar-content p-2" :bid="res">\n\n      <div style="font-size: 18px;">\n        Gathers <span :class="\'ra ra-lg ra-res-\'+res"></span> <b>+{{ Math.floor(prod).estimation() }} {{ res }}</b> per hour.\n        <span @click="show_info=true" class="ra ra-lg ra-icon-question pointer">\n          <span class="path1"></span><span class="path2"></span><span class="path3"></span>\n        </span>\n      </div>\n      \n      <upgrade-button v-if="world.me == town.iso" :town="town" :bid="i"></upgrade-button>\n\n      <hr/>\n\n      <p>\n        <b><u>Total:</u></b> <br/>\n        <span :class="\'ra ra-res-\'+res"></span> <b>{{ Math.floor(amount).estimation() }}</b> (+{{ Math.floor(prod_total).estimation() }} / h).\n      </p>\n\n      <span>{{res == \'food\' ? \'Granary\' : \'Warehouse\'}} capacity:</span>\n      <div class="progress progress-lg">\n        <div :class="\'progress-bar \' + progress_color " role="progressbar" :style="\'width: \'+ round(amount / storage *100) +\'%\'">{{ round(amount / storage *100) }}%</div>\n      </div>\n\n    </div>\n    <div v-else class="infobar-content p-2 scroll" :bid="res">\n      <h3 class="font-brand">How gathering works.</h3>\n\n      <p>You have several resources in the game. Most of them are gathered by resource gatherers that are placed in the Conurbation page. The higher the level of your gatherer, the better your resource income is! Because of this it\'s recommended to start leveling your gatherers before you would level up your buildings.</p>\n\n      <h4><span class="ra ra-res-pop"></span> Population</h4>\n      <p>The people of your city-state grow in numbers by leveling up your buildings and gatherers. Leveling up Wheat Fields, The Granary and Resource Boosters especially yield a boom in population.</p>\n\n      <h4><span class="ra ra-res-gold2"></span> Gold</h4>\n      <p>Gold is used for almost everything, so be wise with your spendings! Unlike other resources, gold is not gathered from a mine or other gatherers, but is collected in the form of taxation. So in short, the bigger the population, the more your gold income is. The Agora building will boost your tax gathering.</p>\n\n      <h4><span class="ra ra-res-wood"></span> Wood</h4>\n      <p>Wood is used for construction and building ships. You can gather wood from nearby forests in your conurbation.</p>\n\n      <h4><span class="ra ra-res-limestone"></span> Limestone</h4>\n      <p>Limestone is used for construction. You can gather it from nearby limestone mines in your conurbation.</p>\n\n      <h4><span class="ra ra-res-marble"></span> Marble</h4>\n      <p>Marble is also used for construction, but it\'s much rarer than wood or limestone. You can\'t do much else about your marble income than leveling up your only marble mine. OR conquer marble territories once you have an army.</p>\n\n      <h4><span class="ra ra-res-bronze"></span> Bronze</h4>\n      <p>Bronze is required for maintaining your Hoplites.</p>\n\n      <h4><span class="ra ra-res-food"></span> Food</h4>\n      <p>The bigger the population, the more mouth you have to feed. Once you start training Hoplites, they will also consume a large chunk of your food. Hoplites eat more food if they\'re farther from their home city-state in a war.</p>\n\n      <h4><span class="ra ra-res-laurel"></span> Holy Points</h4>\n      <p>Holy Points are gathered from leveling up your Temple. Inside your Temple, you can build a skill tree that can unlock various benefits for your country.</p>\n\n      <h4><span class="ra ra-res-emerald"></span> Emerald</h4>\n      <p>MICROTRANSACTION WARNING</p>\n\n      <h4><span class="ra ra-icon-question"></span> I need more gathering</h4>\n      <p>Increasing your gathering can be done in 3 ways:\n        <ul>\n          <li>Level up your gatherers</li>\n          <li>Level up your booster buildings (Stone Mason, Lumberyard, Agora, Mill)</li>\n          <li>Conquer additional territories in the World Map to unlock extra rare gatherers (Marble, Gold, Bronze, Emerald)!</li>\n        </ul>\n      </p>\n\n\n      <button @click="show_info=false" class="btn btn-link">Back</button>\n    </div>\n  </div>\n',data:function(){return{show:!1,infobar_id:null,show_info:!1,town:null,res:null,lvl:0,i:null,amount:0,storage:0,prod:0,prod_total:0}},methods:{open:function(e,n){this.town=e,this.i=parseInt(n),this.res=e.gatherers[n][0],this.lvl=e.gatherers[n][1],this.prod=Object(i.c)(e,this.res,this.lvl),this.prod_total=Object(i.d)(e,this.res),this.storage=Object(i.b)(e,this.res),this.amount=e.resources[this.res]||0,this.infobar_id="gatherer"}},computed:{gather_name:function(){return o.j[this.res].name},progress_color:function(){return o.j[this.res].bg}}});Vue.component("infobar-harbor",{template:'\n  <div v-if="show" class="infobar infobar-lg font-oldie">\n    <infobar-header content="Harbor" :subcontent="\'lvl \'+town.buildings.harbor" infobar_id="harbor"></infobar-header>\n\n    <div v-if="!show_info" class="infobar-content p-2" bid="harbor" style="min-height: 250px">\n\n      <div >\n        <p class="small">Handles trading and the construction of warships.\n          <br/>\n          You can trade at most <b>{{ Math.round(attri) }}</b> resources in total.\n\n          <span @click="show_info=true" class="ra ra-lg ra-icon-question pointer">\n            <span class="path1"></span><span class="path2"></span><span class="path3"></span>\n          </span>\n        </p>\n  \n        <upgrade-button v-if="world.me == town.iso" :town="town" bid="harbor"></upgrade-button>\n      </div>\n\n      <b-tabs content-class="">\n        <b-tab title="Offer" active>\n\n          <div class="d-flex">\n            <div class="flex-fill form-group">\n              <span class="small">Send offer to:</span>\n              <select v-model="trade.to_iso" class="form-control">\n                <option value="">Everyone</option>\n\n                <option v-for="(name,iso) in users" :value="iso">{{name}}</option>\n              </select>\n            </div>\n\n            <div class="m-2">\n              <div class="border border-3 border-black py-1 px-2 rounded mt-2" style="background: #7f7f7f">\n                <span class="ra ra-3x ra-item-galley"></span> \n                <span style="font-size: 1.8em">{{ n_ships }}</span>\n              </div>\n            </div>\n          </div>\n\n          <div class="d-flex">\n            <div>\n              <div class="custom-control custom-radio">\n                <input v-model="trade.type" value="sell" type="radio" id="trade_type1" name="trade_type" class="custom-control-input">\n                <label class="custom-control-label" for="trade_type">Sell</label>\n              </div>\n\n              <div class="custom-control custom-radio">\n                <input v-model="trade.type" value="buy" type="radio" id="trade_type2" name="trade_type" class="custom-control-input">\n                <label class="custom-control-label" for="trade_type">Buy</label>\n              </div>\n            </div>\n\n            <div class="input-group input-group-sm m-1">\n              <div class="input-group-prepend">\n                <span class="input-group-text">\n                  <span :class="\'ra ra-res-\'+trade.material"></span>\n                </span>\n              </div>\n              <input type="number" class="form-control form-control-with-icon" v-model.number="trade.amount" min="0" :max="max_amount" :placeholder="trade.material" />\n            </div>\n\n            <div class="px-1"> for </div>\n\n            <div class="input-group input-group-sm m-1">\n              <div class="input-group-prepend">\n                <span class="input-group-text">\n                  <span :class="\'ra ra-res-gold\'+goldicon"></span>\n                </span>\n              </div>\n              <input type="number" class="form-control form-control-with-icon" v-model.number="trade.gold" min="0" :max="max_gold" placeholder="Gold" />\n            </div>\n\n          </div>\n        </b-tab>\n        <b-tab title="View offers">\n        </b-tab>\n        <b-tab title="Galleys">\n          <div class="float-right">\n            <div class="pointer border border-3 border-black py-1 px-2 rounded mt-2" style="background: #7f7f7f">\n              <span class="ra ra-3x ra-item-galley"></span> \n              <span style="font-size: 1.8em">{{ n_galleys }}</span>\n            </div>\n          </div>\n\n          <div class="">\n            <p>In later patches of Geopoly, you\'ll be able to construct warships!</p>\n          </div>\n\n        </b-tab>\n      </b-tabs>\n\n    </div>\n    <div v-else class="infobar-content p-2 scroll" bid="gymnasium">\n      <h3 class="font-brand">Trading basics</h3>\n\n      <button @click="show_info=false" class="btn btn-link">Back</button>\n    </div>\n  </div>\n',data:function(){return{show:!1,infobar_id:null,show_info:!1,town:null,attri:0,n_ships:0,n_galleys:0,users:[],incoming:[],outgoing:[],last_query:0,trade:{to_iso:"",material:null,amount:0,gold:0,type:"sell"}}},methods:{open:function(e){this.town=e;const n=e.buildings.harbor;this.attri=o.b.harbor.attri[n-1],this.n_ships=Math.floor(this.attri/600),this.infobar_id="harbor",time()-this.last_query>7&&fetch("/api/town/offers").then(e=>e.json()).then(({incoming:e,outgoing:n})=>{this.incoming=e,this.outgoing=n,this.last_query=time()}),0==len(this.users)&&fetch(`/api/worlds/${e.wid}/users`).then(e=>e.json()).then(e=>{this.users=e})}},computed:{max_amount:function(){return this.trade.material?min(this.attri,Object(i.b)(this.town,this.trade.material)):0},max_gold:function(){return Object(i.b)(this.town,"gold")},goldicon:function(){return Object(i.a)(this.trade.gold)}}});let v=null;Events.once("window_onload",()=>{"undefined"!=typeof tf?tf.loadLayersModel("/json/keras_face_model.json").then(e=>{v=e,console.log("Autoencoder model loaded"),_(),x.is_ready=!0,Events&&Events.fire("keras_face_loaded")}):console.error("tensorflow.js is not defined in the global space")});const w=32,y=48;let _=function(){};const x={is_ready:!1};function B(e,n,t){let o=tf.tensor2d([e]);return function(e,n,t){const o=document.createElement("canvas"),i=o.getContext("2d");o.width=w,o.height=y;let r=i.getImageData(0,0,w,y),s=0;for(let o of range(y))for(let i of range(w)){let a=e[i*y+o],l=t.interpolate(n,a);r.data[4*s+0]=l[0],r.data[4*s+1]=l[1],r.data[4*s+2]=l[2],r.data[4*s+3]=255,s++}return i.putImageData(r,0,0),o.toDataURL()}(v.predict(o).dataSync(),n,t)}Vue.component("infobar-hoplite",{template:'\n  <div v-if="show" class="infobar font-oldie">\n    <infobar-header content="Hoplite" infobar_id="acropolis"></infobar-header>\n    <div class="infobar-content p-2" :bid="bid">\n       \n\n        <div class="pointer unit-box text-center p-2" :style="unit_background(unit)" >\n\n\n          <img class="img-fluid" :src="src_unit(unit)" style="min-height:75px" />\n\n          <i class="ra ra-lg ra-panel-world" style="position: absolute; top: 70px"></i>\n        </div>\n\n\n        <div class="progress">\n          <div class="progress-bar bg-danger" role="progressbar" :style="\'width: \'+Math.round(unit.health*100)+\'%\'">\n            <i class="ra ra-health"></i> {{Math.round(unit.health*100)}}\n          </div>\n        </div>\n    </div>\n  </div>\n',data:function(){return{show:!1,infobar_id:null,tf_is_ready:!1,town:null,unit:{health:.75,name:"Sanyi",img_vector:[14.955071477219462,13.13349723815918,0,0,10.605683401226997,20.2440083026886,14.494094701483846,35.36331272125244,13.92039930820465,0,10.493925027549267,0,9.32038402557373,23.72941255569458,0,9.802973076701164]}}},methods:{open:function(e){this.town=e,this.infobar_id="hoplite",this.tf_is_ready||Events.past("keras_face_loaded",()=>{this.tf_is_ready=!0})},src_unit:function(){if(!this.tf_is_ready)return"";let e=this.unit.img_vector,n=new Color("#000000");return B(e,new Color("#ffffff"),n)},unit_background:function(e){return"background: black"}}});Vue.component("town-info",{template:'\n  <div v-if="town">\n    <div class="town-info bg-dark unselectable">\n      <b-collapse :visible="is_visible" ref="coll" id="collapse-1" class="mt-2">\n        <b-card>\n          <div class="card-body">\n\n            <div class="row">\n              <h5 class="col font-brand">{{ town.name }}</h5>\n              \n              <div class="col">\n                <span class="ra ra-res-marble"></span> {{ Math.floor(town.resources[\'marble\']).estimation() }}<br/>\n                <span class="ra ra-res-emerald"></span> 0\n              </div>\n\n            </div>\n\n            <div class="">\n              <span :class="\'ra ra-2x ra-res-gold\'+goldicon"></span> {{ Math.floor(town.resources[\'gold\']).estimation() }} +({{ Math.floor(prod_gold).estimation() }}/h)\n              <br/>\n              <div class="progress progress-sm">\n                <div :class="\'progress-bar bg-warning\'" role="progressbar" :style="\'width: \'+ round(town.resources[\'gold\'] / storage *100) +\'%\'"></div>\n              </div>\n            </div>\n            <div class="">\n              <span class="ra ra-2x ra-res-limestone"></span> {{ Math.floor(town.resources[\'limestone\']).estimation() }} +({{ Math.floor(prod_limestone).estimation() }}/h)\n              <br/>\n        \n              <div class="progress progress-sm">\n                <div :class="\'progress-bar bg-secondary\'" role="progressbar" :style="\'width: \'+ round(town.resources[\'limestone\'] / storage *100) +\'%\'"></div>\n              </div>\n            </div>\n            <div class="">\n              <span class="ra ra-2x ra-res-wood"></span> {{ Math.floor(town.resources[\'wood\']).estimation() }} +({{ Math.floor(prod_wood).estimation() }}/h)\n              <br/>\n              <div class="progress progress-sm">\n                <div :class="\'progress-bar bg-success progress-bar-striped\'" role="progressbar" :style="\'width: \'+ round(town.resources[\'wood\'] / storage *100) +\'%\'"></div>\n              </div>\n            </div>\n            <div class="">\n              <span class="ra ra-2x ra-res-bronze"></span> {{ Math.floor(town.resources[\'bronze\']).estimation() }} +({{ Math.floor(prod_bronze).estimation() }}/h)\n              <br/>\n              <div class="progress progress-sm">\n                <div :class="\'progress-bar bg-copper progress-bar-striped\'" role="progressbar" :style="\'width: \'+ round(town.resources[\'bronze\'] / storage *100) +\'%\'"></div>\n              </div>\n            </div>\n            <div class="">\n              <span class="ra ra-2x ra-res-food"></span> {{ Math.floor(town.resources[\'food\']).estimation() }} +({{ Math.floor(prod_food).estimation() }}/h)\n              <br/>\n              <div class="progress progress-sm">\n                <div :class="\'progress-bar bg-danger\'" role="progressbar" :style="\'width: \'+ round(town.resources[\'food\'] / storage *100) +\'%\'"></div>\n              </div>\n            </div>\n          </div>\n        </b-card>\n      </b-collapse>\n\n      <div class="text-center">\n        <b-button ref="cbtn" v-b-toggle.collapse-1 block variant="link">\n          <span v-if="is_visible" class="ra ra-lg ra-icon-arrow-up"></span>\n          <span v-else class="ra ra-lg ra-icon-arrow-down"></span>\n        </b-button>\n      </div>\n    </div>\n  </div>\n',data:function(){return{show:!1,town:null,is_visible:!0,prod_gold:0,prod_marble:0,prod_limestone:0,prod_wood:0,prod_bronze:0,prod_food:0}},methods:{open:function(e){this.town=e,this.prod_gold=Object(i.d)(e,"gold"),this.prod_marble=Object(i.d)(e,"marble"),this.prod_limestone=Object(i.d)(e,"limestone"),this.prod_wood=Object(i.d)(e,"wood"),this.prod_food=Object(i.d)(e,"food"),this.prod_bronze=Object(i.d)(e,"bronze"),this.storage=Object(i.b)(e,"wood"),this.granary=Object(i.b)(e,"food")}},computed:{goldicon:function(){return this.town?Object(i.a)(this.town.resources.gold):1}},watch:{town:{handler:function(e,n){},deep:!0}}});t(3);const O=t(2).a;function A(e,n,t){O.$refs["town-info"].open(n),e.me=t.iso,Vue.prototype.world=e}const M={move:null,pick:null},k={};let L=null,T=null,N=0;const C={};let Y=0,j=0,P=0;function S({size:e,height:n,grids:t,debug:o,debug_ray:i}){Y=e/(P=t),j=n;const r=Objects.scene;C.debug_ray=i,C.show_coords=!1,C.hover_highlight=!1,N=0;var s=new BABYLON.StandardMaterial("select",r);if(s.diffuseColor=new BABYLON.Color3(.3,.5,.9),s.specularColor=new BABYLON.Color3(.3,.3,.3),s.emissiveColor=BABYLON.Color3.Blue(),(L=BABYLON.MeshBuilder.CreatePlane("select",{width:Y,height:Y},r)).rotate(BABYLON.Axis.X,Math.PI/2,BABYLON.Space.LOCAL),L.isVisible=!1,L.data={},L.isPickable=!1,s.freeze(),L.material=s,r.onPointerObservable.add(e=>{if(!(n=e.pickInfo).hit||"ground"!=n.pickedMesh.name)var n=r.pick(r.pointerX,r.pointerY,e=>"ground"==e.name);if(!n.hit)return;const t=function(e){let n=[Math.floor((e.x+Y/2)/Y),Math.floor((e.z+Y/2)/Y)];return n[0]>=P||n[1]>=P||n[0]<=-P||n[1]<=-P?null:n}(n.pickedPoint),o=I(t);switch(n.pickedCoordinate=t,e.type){case BABYLON.PointerEventTypes.POINTERMOVE:if(M.move)return M.move(n,o,e.event);if(!t)return E();C.hover_highlight&&T!=W(t)&&(T=W(t),L.position.x=o[0],L.position.y=o[1]+.1,L.position.z=o[2],L.isVisible=!0),C.show_coords&&($("#debug-coordinate").innerHTML=W(t));break;case BABYLON.PointerEventTypes.POINTERUP:if(e.event.ctrlKey){n=r.pick(r.pointerX,r.pointerY);new BABYLON.RayHelper(n.ray).show(r),console.log(n.pickedMesh,n.pickedPoint)}0==e.event.button&&M.pick&&M.pick(n,o,e.event)}}),C.debug_ray){const t=new BABYLON.Vector3(0,-1,0);console.info("Size:",e,"Grids:",P,"W_grid:",Y),console.info("Height:",n),console.info("Grid Limits",1-P,P-1);for(let e of range(1-P,P))for(let n of range(1-P,P)){let o=new BABYLON.Vector3(e*Y,j+1,n*Y),i=new BABYLON.Ray(o,t,1.5*j),s=r.pickWithRay(i,e=>"ground"==e.name);new BABYLON.RayHelper(s.ray).show(r),k[W(e,n)]=s.pickedPoint.y}}}function E(){L.isVisible&&(L.isVisible=!1),$("#debug-coordinate").innerHTML=""}function I(e){let n=function(e){const n=Objects.scene,t=new BABYLON.Vector3(0,-1,0);let o=k[W(e)];if(!o){let i=e[0]*Y,r=e[1]*Y,s=new BABYLON.Vector3(i,j+1,r),a=new BABYLON.Ray(s,t,1.5*j),l=n.pickWithRay(a,e=>"ground"==e.name);l.hit?(o=l.pickedPoint.y,k[W(e)]=o):console.error("NO HEIGHT",e,o,k[W(e)])}return o}(e);return e?[Y*e[0],n,Y*e[1]]:null}function z(e,n){M[e.substr(7)]=n}function W(e,n){let t=n?", ":";";return"number"==typeof e?e+t+n:Array.isArray(e)?e.join(t):`${e.x}${t}${e.y}`}let D,H=6;const R={lumberyard:null,stonemason:"stonemason",foundry:"foundry",mill:null,warehouse:"warehouse",granary:"granary",harbor:null,acropolis:"acropolis",agora:"agora",theatre:"theatre",temple:null,house:null,gymnasium:"gymnasium",wall:null},V={lumberyard:[1,1,1,1],stonemason:[1,1,1,1],foundry:[1,1,1,1],mill:[1,1,1,1],warehouse:[1,1,1,1],granary:[1,2,1,1],harbor:[1,1,1,1],acropolis:[4,3,4,1],agora:[5,5,5,5],theatre:[5,4,5,4],temple:[1,1,1,1],house:[1,1,1,1],gymnasium:[1,2,1,3],wall:[1,1,1,1]};let F,q,G=!1;function U(e,n){!function(e,n){let t;const i=R[e];if(i)if(G)BABYLON.SceneLoader.ImportMesh("","/models/buildings/",i+".babylon",D,(function(t,o,i){for(let o of t)o.data={adjust:[o.position.x,o.position.y,o.position.z],dirt_space:V[e]},n(o)}));else{let t=F.addMeshTask("load "+e,"","/models/buildings/",i+".babylon");t.onSuccess=function(t){for(let o of t.loadedMeshes)o.data={adjust:[o.position.x,o.position.y,o.position.z],dirt_space:V[e]},n(o)},t.onError=function(e,n,t){console.error(n,t,i+".babylon")}}else{const i=Objects.scene;t=BABYLON.MeshBuilder.CreateBox(e,{height:H,width:H,depth:H},i);let s=new BABYLON.DynamicTexture("dynamic texture",{width:512,height:256},i);s.getContext();const a=o.c[e].cat_color;s.drawText(e.title(),20,140,"bold 68px monospace",a,"white",!0,!0);var r=new BABYLON.StandardMaterial(e,i);r.diffuseTexture=s,r.specularColor=new BABYLON.Color3(.2,.3,.4),t.material=r,t.data={height:H/2},n(t)}}(e,t=>{if(t.data.bid=e,"MultiMaterial"==t.material.constructor.name){t.material.subMaterials.forEach(e=>{e.freeze()});const n=new BABYLON.StandardMaterial("s"+e,Objects.scene),o=len(t.material.subMaterials);n.emissiveColor=BABYLON.Color3.White(),n.alpha=0,t.subMeshes.push(new BABYLON.SubMesh(o,0,t.getTotalVertices(),0,t.getTotalIndices(),t)),t.material.subMaterials.push(n),t.select_mat=n}n(t)})}const X=1400,K=.02,J=4;let Q,Z,ee,ne=null,te=[],oe=[],ie=!0;const re=0,se=1,ae=2;function le([e,n,t,o],i,r){const s=(Z-1)/2;if(void 0===r)r=!0;for(let r of range(e+s,t+s+1))for(let e of range(n+s,o+s+1))ne[3*(Z*e+r)+re]=i==re?255:0,ne[3*(Z*e+r)+se]=i==se?255:0,ne[3*(Z*e+r)+ae]=i==ae?255:0;r&&pe()}function de([e,n],t,o){let i=e+(Z-1)/2,r=n+(Z-1)/2;void 0===o&&(o=!0),ne[3*(Z*r+i)+re]=t==re?255:0,ne[3*(Z*r+i)+se]=t==se?255:0,ne[3*(Z*r+i)+ae]=t==ae?255:0,o&&pe()}function ce(e,n,t){let o=e.getTextureCoordinates(),i=e.pickedCoordinate;if(void 0===t)t=!0;let r=[Math.floor(o.x*Z),Math.floor(o.y*Z)];if(0==ue(s=r,re)&&255==ue(s,se)&&0==ue(s,ae)){!function([e,n]){ne[3*(Z*n+e)+re]=255,ne[3*(Z*n+e)+se]=0,ne[3*(Z*n+e)+ae]=0}(r),oe.push(i);for(let[e,n]of enumerate(te))n[0]==i[0]&&n[1]==i[1]&&te.splice(e,1)}else{!function([e,n]){ne[3*(Z*n+e)+re]=0,ne[3*(Z*n+e)+se]=255,ne[3*(Z*n+e)+ae]=0}(r),te.push(i);for(let[e,n]of enumerate(oe))n[0]==i[0]&&n[1]==i[1]&&oe.splice(e,1)}var s;t&&pe()}function ue([e,n],t){return ne[3*(Z*n+e)+t]}function pe(){const e=Q.mixTexture;let n=new BABYLON.RawTexture(ne,Z,Z,BABYLON.Engine.TEXTUREFORMAT_RGB,Objects.scene,!1,!1,BABYLON.Texture.TRILINEAR_SAMPLINGMODE,BABYLON.Engine.TEXTURETYPE_UNSIGNED_INT);Q.mixTexture=n,setTimeout(()=>{e&&e.dispose()},200)}h({name:"Roading",module:"roads.js",register:function(e){C.hover_highlight=!0,C.show_coords=!0,e.defaultCursor="cell",e.hoverCursor="default",z("pointerpick",ce)},unregister:function(e){E(),e.defaultCursor="default",e.hoverCursor="pointer",(len(te)||len(oe))&&function(e,n){const t=new FormData;t.append("new_roads",JSON.stringify(e)),t.append("delete_roads",JSON.stringify(n)),fetch("/api/town/roads",{method:"PUT",body:t}).then(e=>e.json()).then(e=>{if(e.error)return c(e)})}(te,oe),te=[],oe=[],z("pointerpick",null)}});const fe={};let he=null,be=null;function ge(e,{build_size:n,enabled:t}){if(t){!function(){const e=new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnLeftPickTrigger,(function(e){let n=e.meshUnderPointer.data.bid;"booster"==o.c[n].type?gui.infobar("booster",be,n):"storage"==o.c[n].type?gui.infobar("storage",be,n):gui.infobar(n,be)})),n=new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnLongPressTrigger,(function(e){b("Moving"),l(e)})),t=new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPointerOverTrigger,(function(e){const n=e.meshUnderPointer.select_mat;n?(n.alpha=.05,n.emissiveColor=BABYLON.Color3.White()):e.meshUnderPointer.material.emissiveColor=new BABYLON.Color3(.02,.02,.02)})),i=new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPointerOutTrigger,(function(e){const n=e.meshUnderPointer.select_mat;n?n.alpha=0:e.meshUnderPointer.material.emissiveColor=BABYLON.Color3.Black()}));const r=new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPointerOverTrigger,(function(e){const n=e.meshUnderPointer.select_mat;n?(n.emissiveColor=BABYLON.Color3.Blue(),n.alpha=.05):e.meshUnderPointer.material.emissiveColor=BABYLON.Color3.Blue()}));let s=null,a=null;function l(e){(s=e.meshUnderPointer).unfreezeWorldMatrix()}function u(e,[n,t,o]){if(s&&e.pickedCoordinate){a=e.pickedCoordinate;const i=s.data.adjust;s.position.x=n+i[0],s.position.y=t+i[1],s.position.z=o+i[2]}}function p(e){s&&(a&&(ve(s,a),function(e,n,[t,o],i){const r=new FormData;r.append("x",t),r.append("y",o),fetch("/api/town/move/"+n,{method:"PUT",body:r}).then(e=>e.json()).then(r=>{if(r.error)return c(r);e.placements[n]=[t,o],i()})}(be,s.data.bid,a,()=>{})),s.freezeWorldMatrix(),s=null,a=null)}const f=new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnLeftPickTrigger,l),m=new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPickOutTrigger,p),v=new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPickUpTrigger,p);function w(e,n){if(null==he)return void console.error("In build mode but to_build is null!");const t=he,o=e.pickedCoordinate;b("Default"),he=null,d(be,t,o,()=>{me(t,e=>{e.data.lvl=1,e.data.coord=o,ve(e,o),g(e)})}),gui.infobar("close")}h({name:"Default",module:"buildings.js",register:function(o){for(let o of Object.values(fe))o.actionManager.registerAction(t),o.actionManager.registerAction(i),o.actionManager.registerAction(e),o.actionManager.registerAction(n);C.hover_highlight=!1,C.show_coords=!0},unregister:function(e){for(let e of Object.values(fe))for(let n of e.actionManager.actions)e.actionManager.unregisterAction(n)}}),h({name:"Building",module:"buildings.js",register:function(e){e.defaultCursor="cell",z("pointerpick",w),C.hover_highlight=!0,C.show_coords=!0},unregister:function(e){e.defaultCursor="default",z("pointerpick",null),E()}}),h({name:"Moving",module:"buildings.js",register:function(e){for(let e of Object.values(fe))e.actionManager.registerAction(r),e.actionManager.registerAction(i),e.actionManager.registerAction(f),e.actionManager.registerAction(m),e.actionManager.registerAction(v);z("pointermove",u),e.hoverCursor="move",e.defaultCursor="move",C.hover_highlight=!1,C.show_coords=!1},unregister:function(e){for(let e of Object.values(fe))for(let n of e.actionManager.actions)e.actionManager.unregisterAction(n);e.hoverCursor="pointer",e.defaultCursor="default",z("pointermove",null)}})}(),be=e,Objects.buildings=fe;for(let[e,n]of Object.items(be.placements)){if("road"==e||"wall"==e)continue;let t=be.buildings[e]||0;0!=t?me(e,e=>{e.data.lvl=t,e.data.coord=n}):console.error("Lvl 0 for building: "+e)}Events.on("build_upgrade",(e,n)=>{!function(e){q.worldOffset=e.position,q.start(),e.select_mat&&(e.select_mat.emissiveColor=BABYLON.Color3.Yellow(),e.select_mat.alpha=.3),X&&setTimeout(()=>{if(q.stop(),e.select_mat){let n=setInterval(()=>{e.select_mat.alpha>0?e.select_mat.alpha-=.08:(e.select_mat.alpha=0,clearInterval(n))},100)}},X)}(fe[e]),g(fe[e])}),Events.on("gfx_loaded",e=>{for(let[e,n]of Object.items(fe))ve(n,n.data.coord,!1);!function(e){if(e.placements.road||(e.buildings.road=1,e.placements.road=[]),!ie)return;for(let n of e.placements.road)de(n,se,!1);pe(),Objects.ground.material=Objects.groundMat,Objects.water,delete Objects.groundMat}(e)})}}function me(e,n){fe[e]?console.error("Mesh is already loaded",e):U(e,t=>{fe[e]=t,t.actionManager=new BABYLON.ActionManager(Objects.scene),n&&n(t),t.freezeWorldMatrix()})}function ve(e,[n,t],o){if(null==o)o=!0;if(!e)return void console.error("Build object doesn't exist",n,t);let[i,r,s,a]=e.data.dirt_space;if(e.data.coord){const[n,t]=e.data.coord;le([n-i,t-r,n+s,t+a],0,!1)}let l=I([n,t]);const d=e.data.adjust;e.unfreezeWorldMatrix(),e.position.x=l[0]+d[0],e.position.y=l[1]+d[1],e.position.z=l[2]+d[2],e.freezeWorldMatrix(),le([n-i,t-r,n+s,t+a],1,o),e.data.coord=[n,t]}Events.on("set_build",e=>{he=e});let we=null;const ye=new Set([]),_e=new Set(["agora","acropolis"]);function xe(e,n){const t=[Ae(n)];for(;n in e;)n=e[n],t.unshift(Ae(n));return t}const Be=[[0,1],[0,-1],[1,0],[-1,0]];function*Oe(e){let[n,t]=Ae(e);for(let[e,o]of Be){let i=n+e+","+(t+o);ye.has(i)&&(yield i)}}function Ae(e){let[n,t]=e.split(",");return[n=parseInt(n),t=parseInt(t)]}function Me(){if(we.placements.road){ye.clear();for(let[e,[n,t]]of Object.items(we.placements))if("road"==e)for(let[e,n]of we.placements.road)ye.add(e+","+n);else{_e.has(e);{let[o,i,r,s]=V[e]||Objects.buildings[e].space;for(let e of range(n-o,n+r+1))for(let n of range(t-i,t+s+1))ye.add(e+","+n)}}}}const ke={};let Le=null;function Te(e,n){const t=Objects.scene;t.getEngine();we=e,setInterval(Me,1800),Me(),Le=e;let o=function(e,n,t){const o=Objects.scene,i=new BABYLON.TransformNode("capsule");var r,s;r=1==e?e:e-1;s=n-r;var a=BABYLON.Mesh.CreateSphere("es1",t,e,o);if(n>=2&&n!==e&&e<n){var l=BABYLON.MeshBuilder.CreateCylinder("mc",{diameterTop:e,diameterBottom:e,tessellation:2*t,height:s-1},o);l.rotation.z=Math.PI/2;var d=BABYLON.Mesh.CreateSphere("es2",t,e,o);a.position.x=(s-1)/2,d.position.x=(1-s)/2}return a.parent=i,l.parent=i,d.parent=i,i.data={coord:null,adjust_y:n/2,path:null,goal:null},i.rotation.z=Math.PI/2,i}(3,6,16);ke[1]=o,Ne(o,Le.placements.acropolis),Events.on("gfx_loaded",()=>{!function(e,n){let t=ke[e],o=Le.placements[n];t.data.goal=n;let i=function(e,n,t){if(Array.isArray(e)&&(e=e[0]+","+e[1]),Array.isArray(n)&&(n=n[0]+","+n[1]),void 0===t)t=(e,t)=>{let[o,i]=Ae(e),[r,s]=Ae(n);return Math.abs(o-r)+Math.abs(i-s)};let o=new Set([e]);const i={},r=defaultdict(()=>1/0,!0);r[e]=0;const s=defaultdict(()=>1/0,!0);s[e]=t(e,n);let a=0;for(;len(o)>0;){const e=Array.from(o).reduce((e,n)=>((null==e.key||s[n]<e.score)&&(e.score=s[n],e.key=n),e),{score:1/0,key:null}).key;if(e==n)return xe(i,e);o.delete(e);for(let a of Oe(e)){let l=r[e]+1;l<r[a]&&(i[a]=e,r[a]=l,s[a]=r[a]+t(a,n),o.add(a))}if(++a>1e3)return console.error("Iteration count exceeded"),!1}return!1}(t.data.coord,o);i?setTimeout(()=>{t.data.path=i},1e3):console.error("path not found",t.data.coord,o)}("1","granary")}),setInterval(()=>{if(!o.data.path)return;if(0==len(o.data.path)||o.data.coord==Le.placements[o.data.goal])return console.info("Goal reached",o.data.goal,o.data.coord),o.data.path=null,void(o.data.goal=null);const e=o.data.path.shift();Ne(o,e)},400);let i=(new Date).getTime();t.registerBeforeRender(()=>{const e=(new Date).getTime()-i;for(let[n,t]of Object.items(ke))t.data.path&&(o.rotation.z=Math.PI/2+Math.PI/8*Math.sin(e/20),o.rotation.y=Math.PI/2+Math.PI/8*Math.cos(e/10))})}function Ne(e,n){e.data.coord=n;let t=I(e.data.coord);e.position.x=t[0],e.position.y=t[1]+e.data.adjust_y,e.position.z=t[2]}let Ce,Ye,je;const Pe=256,Se=10,Ee=99;let Ie=0;const ze=2;function We(e,n,t){var o;Ce=document.getElementById("app-game"),Ye=new BABYLON.Engine(Ce,!0),je=new BABYLON.Scene(Ye),window.Objects={scene:je},H={},F=new BABYLON.AssetsManager(Objects.scene),ge(n,{enabled:!0,build_size:2*round(Pe/Ee)}),o=e=>{++Ie>=ze&&Events.fire("gfx_loaded",[n])},F.onFinish=()=>{G=!0,o()},F.load(),function(e,{free_camera:n,disable_left_click:t,debug:o}){const i=Objects.scene;f=new BABYLON.ArcRotateCamera("Camera",0,.8,140,new BABYLON.Vector3(0,0,0),i),n||(f.lowerBetaLimit=.2,f.upperBetaLimit=Math.PI/2*.9,f.lowerRadiusLimit=80,f.upperRadiusLimit=160),f.panningAxis=new BABYLON.Vector3(1,0,1),f.panningSensibility=60,f.panningDistanceLimit=128,t&&(f.inputs.attached.pointers.buttons[0]=null),Objects.camera=f,o.dashboard&&window.addEventListener("keypress",(function(e){" "==e.key&&(e.preventDefault(),e.stopPropagation(),m?i.debugLayer.hide():i.debugLayer.show(),m=!m)})),f.attachControl(e,!0)}(Ce,{disable_left_click:!0,free_camera:!1,debug:{enabled:!0,ray_helper:!0,no_timeout:!1,dashboard:!0}}),function(e,{sky:n,sun:t,water:o,test_sphere:i,test_light:r,postprocess:s,ground:a},l){const d=a,c=s;if(n)if("globe"==n){var u=BABYLON.Mesh.CreateSphere("skyBox",{diameter:n.distance||5e3,sideOrientation:BABYLON.Mesh.BACKSIDE},e);const t=new BABYLON.StandardMaterial("skyBox",e);t.backFaceCulling=!1,t.reflectionTexture=new BABYLON.Texture("/img/textures/skies/skyglobe",e),t.reflectionTexture.coordinatesMode=BABYLON.Texture.SPHERICAL_MODE,t.diffuseColor=new BABYLON.Color3(0,0,0),t.specularColor=new BABYLON.Color3(0,0,0),t.disableLighting=!0,u.material=t}else if("box"==n){u=BABYLON.Mesh.CreateBox("skyBox",n.distance||5e3,e);const t=new BABYLON.StandardMaterial("skyBox",e);t.backFaceCulling=!1,t.reflectionTexture=new BABYLON.CubeTexture("/img/textures/skies/TropicalSunnyDay",e),t.reflectionTexture.coordinatesMode=BABYLON.Texture.SKYBOX_MODE,t.diffuseColor=new BABYLON.Color3(0,0,0),t.specularColor=new BABYLON.Color3(0,0,0),t.disableLighting=!0,u.material=t}if(t)t=new BABYLON.HemisphericLight("hemiLight",new BABYLON.Vector3(-1,1,0),e);if(r){new BABYLON.PointLight("light2",new BABYLON.Vector3(0,1,-1),e)}if(i){let n=BABYLON.MeshBuilder.CreateSphere("sphere",{diameter:10},e);n.position.y=10,Objects.test_sphere=n}if(d&&d.enabled){const n=d.subdiv||250,t=0;if((a=BABYLON.Mesh.CreateGroundFromHeightMap("ground",`/img/textures/terrain/${d.map}_hm.png`,d.size,d.size,n,t,d.height,e,!1,l)).isPickable=!0,a.freezeWorldMatrix(),a.data={dx:d.size/2,dy:d.size/2,dz:d.height-t},d.add_diffuse_texture){var p=new BABYLON.StandardMaterial("ground",e);p.diffuseTexture=new BABYLON.Texture(`/img/textures/terrain/${d.map}_tex.png`,e),p.specularColor=new BABYLON.Color3(0,0,0),a.material=p}Objects.ground=a}if(o){o=BABYLON.Mesh.CreateGround("water",2048,2048,16,e,!1);var f=new BABYLON.WaterMaterial("water",e,new BABYLON.Vector2(512,512));f.backFaceCulling=!0,f.bumpTexture=new BABYLON.Texture("/img/textures/normals/waterbump.png",e),f.windForce=-2,f.waveHeight=.2,f.bumpHeight=.2,f.windDirection=new BABYLON.Vector2(1,1),f.waterColor=new BABYLON.Color3(0,0,221/255),f.colorBlendFactor=0,f.addToRenderList(u),o.material=f,Objects.water=o}if(c&&"default"!=c.type){const n=Objects.camera,t=new BABYLON.DefaultRenderingPipeline("default",!1,e,[n]);c.antialiasing&&(t.samples=2,t.fxaaEnabled=!0),c.sharpening&&(t.sharpenEnabled=!0,t.sharpen.edgeAmount=.9,t.sharpen.colorAmount=0),c.depth_filter&&(t.depthOfFieldEnabled=!0,t.depthOfFieldBlurLevel=BABYLON.DepthOfFieldEffectBlurLevel.Low,t.depthOfField.focusDistance=1e4,t.depthOfField.focalLength=20),c.photo&&(e.imageProcessingConfiguration.exposure=.8,e.imageProcessingConfiguration.contrast=1.4)}}(je,{debug:!1,test_sphere:!1,test_light:!1,sun:!0,sky:"box",water:!0,ground:{enabled:!0,map:"m3",add_diffuse_texture:!1,size:Pe,height:Se},postprocess:{type:"default_extra",antialiasing:!0,sharpening:!1,depth_filter:!0,photo:!0}},()=>{++Ie>=ze&&Events.fire("gfx_loaded",[n])}),S({debug_ray:!1,hover_highlight:!0,size:Pe,height:Se,grids:Ee}),function(e){if(!e.enabled)return;const n=Objects.scene;(q=new BABYLON.ParticleSystem("particles_lvlup",3600,n)).particleTexture=new BABYLON.Texture("/img/textures/particles/star_hollow.png",n),q.emitter=new BABYLON.Vector3(0,0,0),q.minSize=.1,q.maxSize=.5,q.emitRate=500,q.blendMode=BABYLON.ParticleSystem.BLENDMODE_ONEONE,q.minEmitPower=5,q.maxEmitPower=50,q.updateSpeed=K,q.startPositionFunction=function(e,n){var t=2*Math.random()*Math.PI,o=J*Math.sin(t),i=this.minEmitBox.y,r=J*Math.cos(t);BABYLON.Vector3.TransformCoordinatesFromFloatsToRef(o,i,r,e,n)}}({enabled:!0}),function({enabled:e,size:n,grids:t,height:o,road_size:i,add_meshes:r}){const s=Objects.scene;if(void 0===r)r=!0;if(!e)return void(ie=!1);Z=t,ee=n,(Q=new BABYLON.TerrainMaterial("ground",s)).specularColor=new BABYLON.Color3(0,0,0),ne=new Uint8Array(Z*Z*3);for(let e=0;e<Z;e++)for(let n=0;n<Z;n++)ne[3*(Z*e+n)+re]=255,ne[3*(Z*e+n)+se]=0,ne[3*(Z*e+n)+ae]=0;Q.diffuseTexture1=new BABYLON.Texture("/img/textures/terrain/snow.jpg",s),Q.diffuseTexture2=new BABYLON.Texture("/img/textures/terrain/m3.jpg",s),Q.diffuseTexture3=new BABYLON.Texture("/img/textures/terrain/tex_mars.bmp",s),Q.diffuseTexture1.uScale=Q.diffuseTexture1.vScale=30,Q.diffuseTexture2.uScale=Q.diffuseTexture2.vScale=60,Q.diffuseTexture3.uScale=Q.diffuseTexture3.vScale=60,Q.bumpTexture1=new BABYLON.Texture("/img/textures/normals/snow_norm.jpg",s),Objects.groundMat=Q}({enabled:!0,size:Pe,grids:Ee,height:Se}),Te(n)}function De(e,n,t){this.tilesets={},this.TW=e,this.MODs={},this.TWs={},this.dx=0,this.dy=0,this.canvas=n,this.ctx=n.getContext("2d"),this.setCtx=function(e){this.ctx=e},this.isoToScreen=function(e,n){var t=this.TW;return[t/2*(e-n),(e+n)*(t/4)]},this.screenToIso=function(e,n,t){var o=this.TW,i=(e/(o/2)+n/(o/4))/2,r=n/(o/4)-i;return t?[Math.round(i),Math.round(r)]:[i,r]},this.getMousePos=function(e){let n=this.canvas.getBoundingClientRect();return{x:e.clientX-n.left-this.dx,y:e.clientY-n.top-this.dy}},this.isIn=function(e){let[n,t]=this.isoToScreen(e[0],e[1]);this.canvas.getBoundingClientRect();return t+=this.dy,0<=(n+=this.dx)&&n<=this.canvas.width&&0<=t&&t<=this.canvas.height},this.getCenter=function(e){if("number"==typeof e)e=[e,e];let n=Math.min(e[0],e[1])*this.TW,t=this.canvas.width/2-n/2+n/2,o=this.TW/4+this.canvas.height/2-n/4;return this.dx=t,this.dy=o,[t,o]},n&&this.getCenter(t),this.loadTileset=function(e,n,t,o,i){let r=new Image;r.addEventListener("load",()=>{this.addTileset(e,r,t,o),i()}),r.src=n},this.addTileset=function(e,n,t,o){this.tilesets[e]=n,this.TWs[e]=t,this.MODs[e]=o},this.drawWire=function(e,n){if(!n)n={};let[t,o]=this.isoToScreen(e[0],e[1]),i=this.TW/2,r=this.TW/4;t+=this.dx,o+=this.dy,this.ctx.beginPath(),this.ctx.moveTo(t,o-r),this.ctx.lineTo(t+i,o),this.ctx.lineTo(t,o+r),this.ctx.lineTo(t-i,o),this.ctx.lineTo(t,o-r),n.block_color&&(this.ctx.fillStyle=n.block_color,this.ctx.fill()),n.wire_color&&(this.ctx.strokeStyle=n.wire_color,this.ctx.stroke())},this.drawWires=function(e,n){if("number"==typeof e)e=[e,e];let[t,o]=this.getCenter(e);for(var i=0;i<e[1];i++)for(var r=0;r<e[0];r++){let e="function"==typeof n?n(r,i):n;this.drawWire([r,i],[t,o],e),n.display_coords&&this.drawText(r+","+i,[r,i],[t,o],e)}},this.drawTile=function(e,n,t,o){var i=this.isoToScreen(t[0],t[1]),r=this.MODs[e],s=this.TWs[e],a=Math.floor(n/r),l=n%r;this.ctx.drawImage(this.tilesets[e],l*s,a*s,s,s,this.dx+i[0]-this.TW/2-(s-this.TW)/2,this.dy+i[1]-this.TW/4-((s-this.TW)/2+1),s,s)},this.drawText=function(e,n,t){this.ctx.font="bold 14px Arial",this.ctx.lineWidth=1,this.ctx.textBaseline="middle",this.ctx.textAlign="center";let o=this.isoToScreen(n[0],n[1]);t.stroke_color&&(this.ctx.strokeStyle=t.stroke_color,this.ctx.strokeText(e,this.dx+o[0],this.dy+o[1])),this.ctx.fillStyle=t.text_color||"black",this.ctx.fillText(e,this.dx+o[0],this.dy+o[1])},this.drawLevel=function(e,n,t){let o=this.isoToScreen(n[0],n[1]);this.ctx.strokeStyle=t.stroke_color,this.ctx.fillStyle=t.bg_color||"white",this.ctx.beginPath(),this.ctx.arc(this.dx+o[0],this.dy+o[1],9,0,2*Math.PI),this.ctx.stroke(),this.ctx.fill(),this.ctx.font="bold 12px Arial",this.ctx.lineWidth=1,this.ctx.textBaseline="middle",this.ctx.textAlign="center",this.ctx.fillStyle=t.text_color||"black",this.ctx.fillText(e,this.dx+o[0],this.dy+o[1])}}function He(e){this.m=2147483648,this.a=1103515245,this.c=12345,this.state=e||Math.floor(Math.random()*(this.m-1))}Events.on("gfx_loaded",e=>{console.log("Graphics loaded"),Ye.runRenderLoop((function(){je.render()})),window.addEventListener("resize",(function(){Ye.resize()})),b("Default")}),He.prototype.nextInt=function(){return this.state=(this.a*this.state+this.c)%this.m,this.state},He.prototype.random=function(){return this.nextInt()/(this.m-1)},He.prototype.nextRange=function(e,n){var t=n-e,o=this.nextInt()/this.m;return e+Math.floor(o*t)},He.prototype.choice=function(e){return e[this.nextRange(0,e.length)]},He.prototype.shuffle=function(e){for(let n=e.length-1;n>0;n--){const t=Math.floor(this.random()*(n+1));[e[n],e[t]]=[e[t],e[n]]}return e};const Re=!0,Ve=64,Fe=16;let qe,$e,Ge,Ue,Xe,Ke,Je={},Qe=null;const Ze={wood:[8],marble:[10,11,12,13],bronze:[3],food:[4,5,6,7,9,14],limestone:[0,1,2]},en={render_scenery:!0};function nn(e){const n=Ke.iso.charCodeAt(0)-65+Ke.iso.charCodeAt(1)-65;Xe=new He(n),Ue||(Ue=e);if($e.clearRect(0,0,qe.width,qe.height),$e.shadowBlur=0,$e.lineWidth=0,en.render_scenery)for(let e of range(-Fe,2*Fe,2))for(let n of range(-Fe,2*Fe,2))(Ge.isIn([n,e])||-n-2==e)&&Ge.drawTile("res",15,[n,e],{});else for(let e of range(0,Fe,2))for(let n of range(0,Fe,2))Ge.drawTile("res",15,[n,e],{});for(let e of range(1,Fe,2))for(let n of range(1,Fe,2)){let t=n+","+e;if(Je[t]){let o=Je[t],i=Ke.gatherers[o][1],r=Ke.gatherers[o][0],s=Xe.choice(Ze[r]);Ge.drawTile("res",s,[n,e],{}),i>0&&Ge.drawLevel(i,[n,e],{text_color:"black",stroke_color:"black",bg_color:Qe==t?"#C9C9FF":"white"})}}const t=Ge.canvas.height,o=Ge.canvas.width;$e.beginPath(),$e.shadowColor="black",$e.shadowBlur=15,$e.lineWidth=5,$e.arc(o-250,t/2,t/2,-.5*Math.PI,.5*Math.PI),$e.lineTo(250,t),$e.arc(250,t/2,t/2,.5*Math.PI,-.5*Math.PI),$e.lineTo(o-250,0),$e.closePath(),$e.stroke(),$e.globalCompositeOperation="destination-in",$e.fill(),$e.globalCompositeOperation="source-over",window.requestAnimationFrame(nn)}function tn(e){e.stopPropagation();let n=Ge.getMousePos(e),[t,o]=Ge.screenToIso(n.x,n.y,!0);Re&&($("#debug-coordinate").innerHTML=t+", "+o),t%2==0&&(t-=1),o%2==0&&(o-=1),Je[Qe=t+","+o]?qe.style.cursor="pointer":qe.style.cursor=null}function on(e){e.stopPropagation();let n=Ge.getMousePos(e),[t,o]=Ge.screenToIso(n.x,n.y,!0);t%2==0&&(t-=1),o%2==0&&(o-=1),Je[Qe=t+","+o]&&gui.infobar("gatherer",Ke,Je[Qe])}function rn(e,n,t,o,i){We(0,i),window.gui=O,window.town=i,Events.past("load_game_conf",()=>{A(o,i,n)}),l(i)}function sn(e,n,t,o,i){!function(e,n,t){qe=document.getElementById("app-gathering"),(Ge=new De(Ve,qe,Fe)).setCtx($e=qe.getContext("2d"));let o=0;Ke=n;let i=[];for(let e of range(1,Fe-2,2))for(let n of range(1,Fe-2,2))e!=(Fe-2)/2&&n!=(Fe-2)/2&&i.push(e+","+n);const r=Ke.iso.charCodeAt(0)-65+Ke.iso.charCodeAt(1)-65;(Xe=new He(r)).shuffle(i);for(let[e,n]of enumerate(Ke.gatherers))Je[i[e]]=e;Ge.loadTileset("res","/img/resources.png",128,5,(function(){++o>=1&&(qe.addEventListener("mousemove",tn,!1),qe.addEventListener("mouseup",on,!1),nn())})),Re&&(window.world=e,window.town=Ke)}(o,i),window.gui=O,Events.past("load_game_conf",()=>{A(o,i,n)}),l(i)}t.d(n,"init_town",(function(){return rn})),t.d(n,"init_gathering",(function(){return sn}));n.default={init_gathering:sn,init_town:rn}}]).default}));