!function(e,o){"object"==typeof exports&&"object"==typeof module?module.exports=o():"function"==typeof define&&define.amd?define([],o):"object"==typeof exports?exports.worldmap=o():e.worldmap=o()}(this,(function(){return function(e){var o={};function n(t){if(o[t])return o[t].exports;var s=o[t]={i:t,l:!1,exports:{}};return e[t].call(s.exports,s,s.exports,n),s.l=!0,s.exports}return n.m=e,n.c=o,n.d=function(e,o,t){n.o(e,o)||Object.defineProperty(e,o,{enumerable:!0,get:t})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,o){if(1&o&&(e=n(e)),8&o)return e;if(4&o&&"object"==typeof e&&e&&e.__esModule)return e;var t=Object.create(null);if(n.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:e}),2&o&&"string"!=typeof e)for(var s in e)n.d(t,s,function(o){return e[o]}.bind(null,s));return t},n.n=function(e){var o=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(o,"a",o),o},n.o=function(e,o){return Object.prototype.hasOwnProperty.call(e,o)},n.p="",n(n.s=9)}([function(e,o,n){"use strict";n.d(o,"b",(function(){return t})),n.d(o,"c",(function(){return r})),n.d(o,"a",(function(){return i})),n.d(o,"i",(function(){return l})),n.d(o,"e",(function(){return c})),n.d(o,"d",(function(){return u})),n.d(o,"f",(function(){return d})),n.d(o,"g",(function(){return f})),n.d(o,"h",(function(){return p}));let t={},s={},r={lumberyard:{disabled:!0,cat:"eco",type:"booster",cat_color:"green",cat_bg:"bg-success"},stonemason:{disabled:!1,cat:"eco",type:"booster",cat_color:"green",cat_bg:"bg-success"},foundry:{disabled:!0,cat:"eco",type:"booster",cat_color:"green",cat_bg:"bg-success"},mill:{disabled:!0,cat:"eco",type:"booster",cat_color:"green",cat_bg:"bg-success"},warehouse:{disabled:!1,cat:"eco",type:"storage",cat_color:"green",cat_bg:"bg-success"},granary:{disabled:!1,cat:"eco",type:"storage",cat_color:"green",cat_bg:"bg-success"},harbor:{disabled:!0,cat:"eco",type:"trading",cat_color:"green",cat_bg:"bg-success"},acropolis:{disabled:!1,cat:"infra",type:null,cat_color:"blue",cat_bg:"bg-primary"},agora:{disabled:!1,cat:"infra",type:null,cat_color:"blue",cat_bg:"bg-primary"},theatre:{disabled:!1,cat:"infra",type:null,cat_color:"blue",cat_bg:"bg-primary"},temple:{disabled:!0,cat:"infra",type:null,cat_color:"blue",cat_bg:"bg-primary"},house:{disabled:!0,cat:"infra",type:null,cat_color:"blue",cat_bg:"bg-primary"},road:{disabled:!1,cat:"infra",type:null,cat_color:"blue",cat_bg:"bg-primary"},gymnasium:{disabled:!1,cat:"mil",type:"training",cat_color:"red",cat_bg:"bg-danger"},wall:{disabled:!0,cat:"mil",type:"defensive",cat_color:"red",cat_bg:"bg-danger"}};const i={lumberyard:"wood",stonemason:"limestone",foundry:"bronze",mill:"food"},l={wood:{name:"Forest",bg:"bg-success"},limestone:{name:"Limestone mine",bg:"bg-secondary"},marble:{name:"Marble mine",bg:"bg-white progress-bar-striped"},food:{name:"Wheat fields",bg:"bg-danger"},bronze:{name:"Copper mine",bg:"bg-copper bg-copper progress-bar-striped"},gold:{name:"Taxation",bg:"bg-warning"}};fetch("/json/buildings.json",{cache:"force-cache"}).then(e=>e.json()).then(e=>{t=e.costs,s=e.build_tree,Events.fire("load_game_conf",[])});const a=new Set(["wood","gold","limestone","marble"]);function c(e,o){const n={},s=o;if(!t[e])return console.error("Bid not found",e),{};for(let o of a){if(!t[e][o])continue;const r=t[e][o][s-1];r>0&&(n[o]=r)}return 0==len(n)?null:n}function u(e,o,n){if("number"==typeof o||!isNaN(parseInt(o))){let s=parseInt(o);o=e.gatherers[s][0];if(!n)n=e.gatherers[s][1];return function(e,o,n){const s=n+1;if(!t[o].wood[s-1])return!1;for(let n of a){const r=t[o][n][s-1];if(e.resources[n]<r)return!1}return!0}(e,o,n)}if(r[o].disabled)return!1;const s=n||(e.buildings[o]||0)+1;if(!t[o].wood[s-1])return!1;for(let n of a){const r=t[o][n][s-1];if(e.resources[n]<r)return!1}return!0}function d(e){let o=[];for(let[n,t]of Object.items(s)){if(e.buildings[n])continue;if("road"==n)continue;if(r[n].disabled)continue;let s=!0;for(let[o,n]of t)(e.buildings[o]||0)<n&&(s=!1);s&&o.push(n)}return o}function f(e){let o=[];for(let[n,t]of Object.items(s)){if(e.buildings[n])continue;if("road"==n)continue;if(r[n].disabled)continue;let s=[n,[]],i=0;for(let[o,n]of t)i+=Math.max(0,n-(e.buildings[o]||0)),s[1].push([o,n]);i/len(s[1])<=2.4&&0!=i&&o.push(s)}return o}function p(e,o){let n;n=isNaN(parseInt(o))?c(o,e.buildings[o]):c(e.gatherers[o][0],e.gatherers[o][1]);for(let[o,t]of Object.items(n))e.resources[o]-=t}},function(e,o,n){"use strict";n.d(o,"a",(function(){return t})),n.d(o,"d",(function(){return s})),n.d(o,"b",(function(){return l})),n.d(o,"c",(function(){return a}));const t={not_found:new Color(0,255,255),black:new Color(0,0,0),white:new Color(255,255,255),mil_mark:new Color(150,150,150),exhausted:new Color(40,58,64),base:new Color([211,191,158]),base_edge:new Color([99,84,58])},s={AA:t.base},r=new Set([]);let i={colorscheme:"softlight"};function l(e){if("string"==typeof e)e={iso:e};else if(e.getProperties)e=e.getProperties();let o=e.iso;return o?s[o]?r.has(o)&&["softlight","hardlight"].includes(i.colorscheme)?s[o].blend(t.base,"multiply"):"inverted"==i.colorscheme?s[o].blend(t.base,"multiply"):s[o]:t.not_found:t.base}function a(e,o){let n=null;return n="inverted"==i.colorscheme?s[o]||t.base:["softlight","lineardodge","screen","darken","multiply"].includes(i.colorscheme)?t.base.blend(e,i.colorscheme):e.blend(t.base,i.colorscheme)}},function(e,o,n){"use strict";n.d(o,"d",(function(){return u})),n.d(o,"c",(function(){return d})),n.d(o,"b",(function(){return f})),n.d(o,"e",(function(){return p})),n.d(o,"a",(function(){return g}));var t=n(0);const s={wood:"lumberyard",limestone:"stonemason",bronze:"foundry",food:"mill",gold:"agora",marble:"__nothing__"},r=1,i=11e3,l=1e5,a=30,c=.9;function u(e,o){if("gold"==o)return d(e,o,1);let n=0;for(let[t,s]of e.gatherers)t==o&&(n+=d(e,t,s));return n}function d(e,o,n){if(n<=0)return 0;let i=1,l=s[o]||null;if(l in e.buildings){let o=e.buildings[l];o>0&&(i=1+t.b[l].attri[o-1]/100)}return"gold"==o?i*e.resources.pop*c*r:t.b[o].prod[n-1]*i*r}function f(e,o){if("holy"==o)return a;if("emerald"==o)return l;if("pop"==o)return i;let n="warehouse";"food"==o&&(n="granary");let s=e.buildings[n]||0;return 0==s?0:t.b[n].attri[s-1]}function p(e,o){const n=o/3600;return e.resources.wood+=Math.min(f(e,"wood"),u(e,"wood")*n),e.resources.food+=Math.min(f(e,"food"),u(e,"food")*n),e.resources.gold+=Math.min(f(e,"gold"),u(e,"gold")*n),e.resources.marble+=Math.min(f(e,"marble"),u(e,"marble")*n),e.resources.bronze+=Math.min(f(e,"bronze"),u(e,"bronze")*n),e.resources.limestone+=Math.min(f(e,"limestone"),u(e,"limestone")*n),!0}function g(e){return e>=1e6?5:e>=1e5?4:e>=5e3?3:e>=200?2:1}},function(e,o,n){"use strict";n.d(o,"a",(function(){return d})),n.d(o,"b",(function(){return f})),n.d(o,"c",(function(){return p}));const t={},s=[],r=[];let i=0,l=0;const a={};function c(){if(function(e){let o=!0;for(let[n,s]of e){let e=n.reduce((e,o)=>e&&Boolean(t[o]),!0);e||(o=!1),e&&s(a)}return o}(r))for(let e in a)delete a[e]}class u{constructor(e){this.name=e,this.ctx=a}loaded(){t[this.name]=!0,++l>=i&&c()}before_loadend(e){s.push(e)}after_loadend(e){r.push(e)}finished(e){r.push(e)}}function d(e,o){void 0===t[e]&&(t[e]=!1,o.call(new u(e)))}function f(e,o){Array.isArray(e)||(e=[e]),r.push([e,o])}function p(...e){i=e.length}},function(e,o,n){"use strict";n.d(o,"a",(function(){return t}));let t={},s={};$("#app-gui").innerHTML&&(t=new Vue({el:"#app-gui",data:{opened_comp:null,opened:null,opened_type:null,infobar_lastpos:defaultdict(list,!0)},methods:{child:function(e){return this.$refs[e]},infobar:function(e,...o){this.opened_comp&&"infobar"!=this.opened_type&&(this.opened_comp.show=!1,this.opened=null,this.opened_type=null);let n=this.$refs["infobar-"+e];if(n){if(n.open(...o),n.show=!0,this.opened_comp=n,this.opened=e,this.opened_type="infobar",t.infobar_lastpos[t.opened]){const[e,o]=t.infobar_lastpos[t.opened];Vue.nextTick(()=>{n.$el.style.left=e+"px",n.$el.style.top=o+"px"})}return n}},dialog:function(e,...o){this.opened_comp&&"infobar"!=this.opened_type&&(this.opened_comp.show=!1,this.opened=null,this.opened_type=null);let n=this.$refs["dialog-"+e];if(n)return n.open(...o),n.show=!0,this.opened_comp=n,this.opened=e,this.opened_type="dialog",n},overlay:function(e,o,...n){this.opened_comp&&"infobar"!=this.opened_type&&(s[this.opened]&&s[this.opened].setPosition(void 0),this.opened_comp.show=!1,this.opened=null,this.opened_type=null);let r=this.$refs["overlay-"+e];if(r){if(r.open(...n),r.show=!0,this.opened_comp=r,this.opened=e,this.opened_type="overlay",s[e])s[e].setPosition(o);else{const n=new ol.Overlay({element:t.$refs["overlay-"+e].$el,position:o,autoPan:!0,autoPanAnimation:{duration:250}});map.addOverlay(n),s[e]=n}return r}},flash:function(e,o,n){this.$refs.flash.display(e,o,n)},quit:function(e){if(e){const o=this.$refs[e];if(!o)return void console.error("Trying to close unknown gui element",e);o.close?o.close():o.show=!1}else for(let e in this.$refs)this.quit(e);(this.opened_comp||this.opened)&&(this.opened_comp=null,this.opened=null)}},computed:{frame:function(){return this.$refs.frame}}}))},function(e,o,n){"use strict";var t=n(1);n(3);const s=new Set([]),r={w:512,h:512};let i=document.createElement("canvas");i.width=r.w,i.height=r.h;i.getContext("2d");let l=[0,0],a=!1;Vue.mixin({methods:{open_dialog:function(e,...o){gui.dialog(e,...o)},open_infobar:function(e,...o){gui.infobar(e,...o)},close_infobar:function(e){gui.$refs["infobar-"+e]&&gui.$refs["infobar-"+e].onclose&&gui.$refs["infobar-"+e].onclose(),gui.quit("infobar-"+e)},infobar_mousedown:function(e){const o=e.target.parentElement;"infobar "==o.className.substr(0,8)&&(a=!0,l=[o.offsetLeft-e.clientX,o.offsetTop-e.clientY])},infobar_mouseup:function(e){a=!1},infobar_mousemove:function(e,o){if(e.preventDefault(),a){const n=e.target.parentElement,t=e.clientX+l[0],s=e.clientY+l[1];n.style.left=t+"px",n.style.top=s+"px",gui.infobar_lastpos[o]=[t,s]}},maxHeight:function(){return"max-height: "+($("#app-map").offsetHeight-220)+"px;"},area_color:function(e){return"color: "+Object(t.b)(e).contrast()+";"},area_background:function(e){var o=Object(t.b)(e);return"background: "+o.rgba()+";"+("color: "+o.contrast()+";")},unit_background:function(e){let o=Object(t.b)(e);for(;"black"==o.contrast();)o=o.shade(-.15);return"background: "+o.rgba()+";"+("color: "+o.contrast()+";")},herald:function(e){let o;if(o="string"==typeof e?e:e.get||e.getProperties?e.get("iso"):e.iso,s.has(o))var n="background-image: "+("url('/img/flags/flag_"+o+".png')")+";background-position:center;";else n="background-color: "+Object(t.b)(e).rgb()+";";return n}}})},function(e,o,n){"use strict";var t=n(2);Vue.component("town-info",{template:'\n  <div v-if="town">\n    <div class="town-info bg-dark unselectable">\n      <b-collapse :visible="is_visible" ref="coll" id="collapse-1" class="mt-2">\n        <b-card>\n          <div class="card-body">\n\n            <div class="row">\n              <h5 class="col font-brand">{{ town.name }}</h5>\n              \n              <div class="col">\n                <span class="ra ra-res-marble"></span> {{ Math.round(town.resources[\'marble\']).estimation() }}<br/>\n                <span class="ra ra-res-emerald"></span> 0\n              </div>\n\n            </div>\n\n            <div class="">\n              <span :class="\'ra ra-2x ra-res-gold\'+goldicon"></span> {{ Math.round(town.resources[\'gold\']).estimation() }} +({{ Math.round(prod_gold).estimation() }}/h)\n              <br/>\n              <div class="progress progress-sm">\n                <div :class="\'progress-bar bg-warning\'" role="progressbar" :style="\'width: \'+ round(town.resources[\'gold\'] / storage *100) +\'%\'"></div>\n              </div>\n            </div>\n            <div class="">\n              <span class="ra ra-2x ra-res-limestone"></span> {{ Math.round(town.resources[\'limestone\']).estimation() }} +({{ prod_limestone.estimation() }}/h)\n              <br/>\n        \n              <div class="progress progress-sm">\n                <div :class="\'progress-bar bg-secondary\'" role="progressbar" :style="\'width: \'+ round(town.resources[\'limestone\'] / storage *100) +\'%\'"></div>\n              </div>\n            </div>\n            <div class="">\n              <span class="ra ra-2x ra-res-wood"></span> {{ Math.round(town.resources[\'wood\']).estimation() }} +({{ prod_wood.estimation() }}/h)\n              <br/>\n              <div class="progress progress-sm">\n                <div :class="\'progress-bar bg-success progress-bar-striped\'" role="progressbar" :style="\'width: \'+ round(town.resources[\'wood\'] / storage *100) +\'%\'"></div>\n              </div>\n            </div>\n            <div class="">\n              <span class="ra ra-2x ra-res-bronze"></span> {{ Math.round(town.resources[\'bronze\']).estimation() }} +({{ prod_bronze.estimation() }}/h)\n              <br/>\n              <div class="progress progress-sm">\n                <div :class="\'progress-bar bg-copper progress-bar-striped\'" role="progressbar" :style="\'width: \'+ round(town.resources[\'bronze\'] / storage *100) +\'%\'"></div>\n              </div>\n            </div>\n            <div class="">\n              <span class="ra ra-2x ra-res-food"></span> {{ Math.round(town.resources[\'food\']).estimation() }} +({{ prod_food.estimation() }}/h)\n              <br/>\n              <div class="progress progress-sm">\n                <div :class="\'progress-bar bg-danger\'" role="progressbar" :style="\'width: \'+ round(town.resources[\'food\'] / storage *100) +\'%\'"></div>\n              </div>\n            </div>\n          </div>\n        </b-card>\n      </b-collapse>\n\n      <div class="text-center">\n        <b-button ref="cbtn" v-b-toggle.collapse-1 block variant="link">\n          <span v-if="is_visible" class="ra ra-lg ra-icon-arrow-up"></span>\n          <span v-else class="ra ra-lg ra-icon-arrow-down"></span>\n        </b-button>\n      </div>\n    </div>\n  </div>\n',data:function(){return{show:!1,town:null,is_visible:!0,prod_gold:0,prod_marble:0,prod_limestone:0,prod_wood:0,prod_bronze:0,prod_food:0}},methods:{open:function(e){this.town=e,this.prod_gold=Object(t.d)(e,"gold"),this.prod_marble=Object(t.d)(e,"marble"),this.prod_limestone=Object(t.d)(e,"limestone"),this.prod_wood=Object(t.d)(e,"wood"),this.prod_food=Object(t.d)(e,"food"),this.prod_bronze=Object(t.d)(e,"bronze"),this.storage=Object(t.b)(e,"wood"),this.granary=Object(t.b)(e,"food")}},computed:{goldicon:function(){return this.town?Object(t.a)(this.town.resources.gold):1}},watch:{town:{handler:function(e,o){},deep:!0}}})},function(e,o,n){"use strict";Vue.component("infobar-header",{template:'\n\n\n  <div @mousedown="infobar_mousedown" @mouseup="infobar_mouseup" @mousemove="infobar_mousemove($event, infobar_id)" class="infobar-header unselectable" :style="iso ? area_background(iso) : \'\'">\n    <div v-if="iso" :class="\'border border-dark rounded d-inline-block flag flag-xs flag-\'+iso"></div>\n\n    {{ content }}\n\n    <span v-if="subcontent" class="small">{{ subcontent }}</span>\n\n    <button type="button" class="close" aria-label="Close" @click="close_infobar(infobar_id)">\n      <span aria-hidden="true">&times;</span>\n    </button>\n  </div>\n\n',props:{content:{default:""},subcontent:{default:""},iso:{default:null},infobar_id:{default:""}}})},,function(e,o,n){"use strict";n.r(o),ol.style.IconImageCache.shared.setSize(512);const t=new ol.View({center:[0,0],zoom:5}),s=new ol.Map({layers:[],target:"app-map",controls:ol.control.defaults({attribution:!1}),interactions:ol.interaction.defaults({doubleClickZoom:!1}),view:t}),r={keyup:[],keydown:[],keypress:[],hover:[],click:[],rightclick:[],contextmenu:[]};s.on("click",e=>{if(!l.smartcast_enabled&&l.key_pressed&&l.smartcastable.has(l.key_pressed))s.forEachFeatureAtPixel(e.pixel,(e,o)=>{o.keypress&&o.keypress(e,l.key_pressed)});else{let o=!1,n=e.originalEvent.ctrlKey?"CTRL":e.originalEvent.shiftKey?"SHIFT":e.originalEvent.altKey?"ALT":null;if(s.forEachFeatureAtPixel(e.pixel,(t,s)=>{s.click&&(s.click(t,n,e),o=!0)}),!o)for(let e of r.click)e(null)}}),s.getViewport().addEventListener("contextmenu",(function(e){e.preventDefault();let o=!1;if(s.forEachFeatureAtPixel(s.getEventPixel(e),(e,n)=>{n.rightclick&&(n.rightclick(e,l.key_pressed),o=!0)}),!o)for(let e of r.rightclick)e(null)}));const i={last_pointer_event:0,busy:!1};s.on("pointermove",e=>{if(i.busy)return;l.smartcast_enabled&&(l.mouse_pixel=e.pixel);let o=(new Date).getTime();if(o-i.last_pointer_event<50)return;i.last_pointer_event=o;let n=!1;if(s.forEachFeatureAtPixel(e.pixel,(e,o)=>{o.hover&&(n=!0,o.hover(e))}),!n)for(let e of r.hover)e(null)}),s.on("movestart",e=>{i.busy=!0}),s.on("moveend",e=>{i.busy=!1});let l={smartcast_enabled:!0,global_keypress:new Set([]),smartcastable:new Set([]),smartcast_happened:!1,key_pressed:null,mouse_pixel:null};document.onkeydown=function(e){const o=e.key.toUpperCase();if(l.smartcast_enabled&&l.smartcastable.has(o)){if(e.preventDefault(),l.smartcast_happened)return;l.smartcast_happened=!0,null!=l.mouse_pixel&&s.forEachFeatureAtPixel(l.mouse_pixel,(e,n)=>{n.keypress&&n.keydown(e,o)})}else l.smartcast_enabled||(e.preventDefault(),l.key_pressed=o);if(l.global_keypress.has(o)){e.preventDefault();for(let e of r.keydown)e(null,o)}},document.onkeyup=function(e){l.key_pressed=null;const o=e.key.toUpperCase();if(l.smartcast_enabled&&(l.smartcast_happened=!1),l.global_keypress.has(o)){e.preventDefault();for(let e of r.keyup)e(null,o)}};n(7);const a=new function(){this.groups={},this.model={},this.subscribed={},this.reoccuring={},this.onconnected_func=[],this.ondisconnected_func=[],this.onerror_func=[],this.ws=null,this.log_style="color: purple",this.address=null,this.c_msid=1,this.trying=!1,this.request=function(e,o){if(!this.ws||1!=this.ws.readyState)return console.error("WebSocket is not connected"),{then:()=>{}};if(o||"string"==typeof e)o||(o={}),o.route=e;else o=e;o.route||console.error("No route defined for request: ",o),o.msid=this.c_msid++,console.info(`%c<${e} (${o.msid})`,a.log_style,o);var n=JSON.stringify(o);return this.ws.send(n),new c(e,o.msid)},this.onconnect=function(e){this.onconnected_func.push(e)},this.ondisconnect=function(e){this.ondisconnected_func.push(e)},this.onerror=function(e){this.onerror_func.push(e)},this.onmessage=function(e){if(null!=e.data)var o=JSON.parse(e.data);else o=e;try{var n=o.route.split(":"),t=a.groups[n[0]]||this;console.info("%c>"+o.route+`(${o.msid||"0"})`,"color:purple",o);try{delete(s=Object.assign({},o)).route}catch(e){var s=o}s.params&&(s=s.params),o.msid&&a.subscribed[o.msid]?(a.subscribed[o.msid].apply(t,[s]),delete a.subscribed[o.msid]):a.subscribed[o.route]&&(a.subscribed[o.route].apply(t,[s]),delete a.subscribed[o.route]),a.reoccuring[o.route]&&a.reoccuring[o.route].apply(t,[s]);var r=t[n[1]];r&&r.apply(t,[s])}catch(e){console.error(e)}},this.on=function(e,o){this.reoccuring[e]=o},this.connect=function(e,o){this.address=e;try{this.ws=new WebSocket(e)}catch(e){for(let e of a.ondisconnected_func)e();return}this.ws.onopen=function(e){console.info("%cConnected to websocket",a.log_style);for(let e of a.onconnected_func)e();o()},this.ws.onerror=function(e){if(this.ws&&1!=this.ws.readyState){console.info("%cError with connecting to websocket",a.log_style),a.trying=!1;for(let e of a.ondisconnected_func)e()}else for(let e of a.onerror_func)e()},this.ws.onclose=function(e){console.info("%cDisconnected from websocket",a.log_style),a.trying=!1;for(let e of a.ondisconnected_func)e()},this.ws.onmessage=this.onmessage},this.reconnect=function(e){a.trying||a.tryReconnect(1,e)},this.tryReconnect=function(e,o,n,t){if(null==e)e=1;0!=e?a.ws.readyState!==a.ws.OPEN&&(a.trying||(a.trying=!0,console.info("%cTrying to reconnect..",a.log_style),null!=t&&t(),a.connect(a.address,(function(){a.trying=!1,console.info("%cReconnect successful",a.log_style),null!=o&&o()}))),setTimeout(()=>{a.tryReconnect(e--)},4e3)):null!=n&&n()}};var c=function(e,o){this.then=function(e){a.subscribed[o]=e}};let u=a;var d=n(1);Vue.component("chat-gui",{template:'\n<div v-if="show">\n  \n  <div class="d-flex">\n    <div class="p-2 flex-fill">\n      \n      <div class="chat-messages-wrapper">\n\n        \x3c!-- list of messages --\x3e\n        <div class="scroll chat-messages">\n          <div v-for="message in messages" class="chat-message">\n            <strong v-if="config.msg_show_country && message.iso && config.country_style == \'iso\'" :style="style_get_color(message.iso)">[{{message.iso}}]</strong> \n            <div v-else-if="config.msg_show_country && message.iso && config.country_style == \'flag\'" :class="\'flag d-inline-block flag-xs flag-\'+message.iso"></div>\n            <div v-else-if="config.msg_show_country && message.iso && config.country_style == \'herald\'">NO_HERALD</div>\n\n            <strong v-if="config.msg_show_username && message.username" :style="style_get_color(message.iso)">{{message.username}}:</strong> \n\n            <span v-html="message.msg"></span>\n          </div>\n        </div>\n        \n      </div>\n\n    </div>\n    <div class="p-2">\n\n      <div v-if="err" class="text-danger bg-light">{{ err }}</div>\n\n      \x3c!-- online users --\x3e\n      <div v-for="(username,iso) in online" class="chat-user">\n        <strong v-if="config.prof_show_country && iso && config.country_style == \'iso\'" :style="style_get_color(iso)">[{{iso}}]</strong> \n        <div v-else-if="config.prof_show_country && iso && config.country_style == \'flag\'" :class="\'flag d-inline-block flag-xs flag-\'+iso"></div>\n        <div v-else-if="config.prof_show_country && iso && config.country_style == \'herald\'">NO_HERALD</div>\n\n        <strong v-if="config.prof_show_username && username" :style="style_get_color(iso)">{{username}}</strong> \n      </div>\n      \n    </div>\n  </div>\n\n  \x3c!-- Bottom inputs --\x3e\n  <div class="">\n    <div class="input-group">\n      <input ref="inputter" class="form-control chat-input" v-model="msg_input" v-on:keydown.enter="on_submit" v-on:keydown.stop=""  />\n\n      <div class="input-group-append">\n        <button v-on:click="on_submit" class="btn btn-outline-warning" type="button">Send</button>\n      </div>\n    </div>\n  </div>\n\n</div>\n',props:["roomId"],data:function(){return{show:!0,config:{},prev_iso:null,username_func:function(e){return e},err:null,msg_input:"",messages:[],online:{},actions:{},emojis:{}}},created:function(){u.connected&&this.sub()},methods:{sub:function(){u.request("Chat:subscribe",{room_id:this.roomId}).then(({messages:e,users:o})=>{this.show=!0,this.messages.splice(0,this.messages.length);for(let o of e)this.add_message(o);this.online={};for(let e of o)this.add_user(e,this.username_func(e))}),u.on("Chat:message",({room_id:e,msg:o})=>{this.add_message(o)}),u.on("Chat:subscribed",({username:e,iso:o})=>{this.add_user(o,e)}),u.on("Chat:unsubscribed",({username:e,iso:o})=>{delete this.online[o]}),this.config.toggle_on_enter&&(window.removeEventListener("keydown",this.onkey),window.addEventListener("keydown",this.onkey))},onkey:function(e){13===e.keyCode&&(this.show||(this.show=!0),Vue.nextTick(()=>{this.$refs.inputter&&this.$refs.inputter.focus()}))},add_message:function(e){let o=e.msg.match(/\:([a-z0-9\s\_\-]*.)\:/gi);if(o)for(let n of o)n=n.substr(1,n.length-2),this.emojis[n]&&(e.msg=e.msg.replace(":"+n+":",`<img title=":${n}:" class="chat-emoji" gicon=":${n}:" src="/img/chat/${this.emojis[n]}" />`));this.messages.push(e),setTimeout(()=>{var e=this.$el.querySelector(".chat-messages");e.scrollTop=e.scrollHeight},10)},add_user:function(e,o){this.online[e]&&!o||(this.online[e]=o||null)},on_submit:function(){if(""==this.msg_input)return void(this.show&&this.config.toggle_on_enter&&(this.show=!1));let e=this.msg_input.match(/\/([a-z0-9\s\_\-]*.)/gi);if(e)for(let o of e)o=o.substr(1,o.length-1),this.actions[o]&&this.actions[o](this.msg_input);else u.request("Chat:message",{room_id:this.roomId,msg:this.msg_input});this.msg_input=""},style_get_color:function(e){return"color: "+Object(d.b)(e).rgb()}},watch:{messages:function(){}}});n(6),n(5);const f=n(4).a;var p=n(3);const g={loaded:!1,wid:null,username:null,uid:null,me:null,spectator:!1,players:{},map:null},h={};function b(e){if(g.name=e.name,g.loaded=!0,g.wid=e.wid,e.map&&(g.map=e.map),void 0!==e.turns){for(let o of Object.keys(e))g[o]=e[o];g.turns=e.turns||0,g.rounds=e.rounds||0,g.max_rounds=e.max_rounds||0,g.turn_time=e.turn_time||0}}Object(p.b)("world",e=>{if(e.world&&!g.loaded&&b(e.world),e.debug&&(window.world=g,window.countries=h),e.countries){g.isos=[];for(let o of e.countries)e.players&&e.players[o.iso]&&(o.username=e.players[o.iso].username,o.division=e.players[o.iso].division),g.isos.push(o.iso),o.color&&(d.d[o.iso]=new Color(o.color)),h[o.iso]=o;g.isos.sort((e,o)=>{h[e].order,h[o].order})}});const m=new ol.layer.Tile({source:new ol.source.Stamen({layer:"watercolor"})});m.name="watercolor";const w=new ol.source.Vector({format:new ol.format.GeoJSON({}),url:"/maps/polis.geojson"}),y=new ol.layer.Vector({source:w,style:(e,o)=>{const n=[],t=e.get("hovered"),s=e.get("username"),r=e.getId();let i=d.a.base,l=d.a.base_edge;return(s||t)&&(l=Object(d.b)(r),i=Object(d.c)(l,r)),n.push(new ol.style.Style({image:new ol.style.Circle({fill:new ol.style.Fill({color:i.rgb()}),stroke:new ol.style.Stroke({color:l.rgb(),lineCap:"square",lineDash:[.1,8],width:4}),radius:14})})),n.push(new ol.style.Style({text:new ol.style.Text({text:e.get("name"),fill:new ol.style.Fill({color:i.rgb()}),stroke:new ol.style.Stroke({color:l.rgb(),width:3}),font:'16px "herakles"',offsetY:28})})),s&&t&&n.push(new ol.style.Style({text:new ol.style.Text({text:s,fill:new ol.style.Fill({color:"white"}),stroke:new ol.style.Stroke({color:"black",width:2}),font:'14px "Times New Roman"',offsetY:44})})),n}});y.name="areas",y.click=(e,o)=>{if("CTRL"==o)return console.log(e.getId(),e.getProperties());e.getId()==g.me?window.location="/town":window.location="/town/"+e.getId()+"/"+e.get("name")},y.rightclick=(e,o)=>{console.log(e,o)},y.keydown=(e,o)=>{console.log(e,o)},y.keyup=(e,o)=>{console.log(e,o)};let _=null;function v(e,o){console.info(e,"called with",o)}y.hover=e=>{_&&(_.set("hovered",!1),_=null),e?(e.set("hovered",!0),_=e,$("#app-map").style.cursor="pointer"):$("#app-map").style.cursor=""},Object(p.a)("towns",(function(){var e=w.on("change",o=>{"ready"==w.getState()&&len(w.getFeatures())>0&&(ol.Observable.unByKey(e),this.loaded())})}));const k={controllers:{},groups:{},ws:u,init_game_client:function(e,o,n){this.conf=e,e.websocket?(this.ws.groups=this.groups,this.ws.connect(e.ws_address,()=>{this.request_auth(o,n)}),this.ws.onerror(e=>{console.error(e)}),this.ws.ondisconnect(e=>{"disconnect"!=gui.opened&&gui.dialog("disconnect","reconnect"),this.ws.tryReconnect(1,()=>{this.request_auth(o,()=>{gui.$refs["global-chat"].err=null})},()=>{gui.$refs["global-chat"].err="Failed to reconnect."},()=>{gui.$refs["global-chat"].err="Attempting to reconnect..."})})):this.ws.request=v,e.debug&&(window.client=k)},request_auth:function({uid:e,token:o},n){const t=this.ws.request("Users:auth_token",{uid:e,token:o});null!=n&&t.then(n)}};var x;function C(e,o,n,s,r){let i;t.setCenter([2548e3,4581e3]),t.setZoom(8),t.setMinZoom(7),t.setMaxZoom(11);for(let e of r)e.iso==o.iso&&(i=e);k.init_game_client(e.client,o,()=>{e.chat.enabled?function(e,o){e.emojis={meh:"meh.png",flup:"flup.png",eme:"eme_logo.png",headbop:"headbop.gif",thunk:"thunk.png",sadgry:"sadgry.png",obey:"obey.png",smh:"smh.gif",cat:"katzen.png","whoa mama":"whoa_mama.png",wowzors:"wowzors.png",pappa:"pappa.gif",triggered:"triggered.png",trump:"trump.gif",mummy:"mummy.png",metroplier:"metroplier.png",sorry_hihi:"sorry_hihi.png",quigon:"quigon.png"},e.actions={"ilyesadam bazmeg":()=>{},"and now my order is in YOUR court":()=>{}},e.username_func=e=>{w.getFeatureById(e).get("username")};try{e.config=o,e.sub(),e.onmessage=()=>{}}catch(e){console.error("Chat module failed: ",e)}window.onbeforeunload=()=>{e.unsub()}}(f.$refs["global-chat"],e.chat):f.$refs["global-chat"]&&(f.$refs["global-chat"].show=!1)}),window.gui=f,window.world=g,window.townSource=w,Object(p.a)("world",(function(){this.ctx.towns=r,b(s),function(e){e&&e.wid&&(g.wid=e.wid,g.uid=e.uid,g.me=e.iso,g.username=e.username)}(o),this.loaded()})),Object(p.b)(["build_conf"],()=>{!function(e,o,n){f.$refs["town-info"].open(o)}(0,i)})}n.d(o,"default",(function(){return C})),s.getLayers().extend([m,y]),x={global_keypress:new Set([" ","ESCAPE","TAB"])},s.getLayers().forEach(e=>{e.keyup&&r.keyup.push(e.keyup),e.keydown&&r.keydown.push(e.keydown),e.keypress&&r.keypress.push(e.keypress),e.hover&&r.hover.push(e.hover),e.click&&r.click.push(e.click),e.rightclick&&r.rightclick.push(e.rightclick),e.contextmenu&&r.contextmenu.push(e.contextmenu)}),l.global_keypress=x.global_keypress,Object(p.c)(["build_conf"]),Object(p.b)(["world","towns"],e=>{for(let o of e.towns){w.getFeatureById(o.iso).setProperties(o)}let o=w.getFeatureById(g.me);o&&(t.setCenter(o.getGeometry().getCoordinates()),t.setZoom(10))}),d.d.TN=new Color([17,2,233]),d.d.TH=new Color([197,50,50]),d.d.SP=new Color([207,20,43]),d.d.CO=new Color([149,37,87]),d.d.AT=new Color([22,55,137]),d.d.OL=new Color([254,15,88]),d.d.DE=new Color([53,91,87]),d.d.RH=new Color([190,127,4]),d.d.KN=new Color([195,130,48]),d.d.MG=new Color([154,105,33]),d.d.AR=new Color([3,7,147]),d.d.ER=new Color([96,122,193]),d.d.TG=new Color([35,77,15]),d.d.ST=new Color([11,48,212]),d.d.PT=new Color([120,121,0]),d.d.SM=new Color([128,78,56]),d.d.MA=new Color([170,110,40]),d.d.NA=new Color([81,35,104]),d.d.LA=new Color([215,67,32]),d.d.ME=new Color([63,120,35])}]).default}));