{% extends "layout_game.html" %}
{% set active_page = "World" %}

{% block scripts %}
{% endblock %}

{% block content_body %}
  <div class="container" style="margin-top:80px">

    <div class="card card-paper">
      <div class="card-header">
        <h1>Accepting invitation</h1>
      </div>
      <div class="card-body">

        {% if current_user.wid %}
          <p >You are already in a world! This means that your world <b><u>is going to be merged</u></b> into the other world.</p>
          <p id="merge_err" class="text-danger"></p>

          <p>You're about to merge your world instance into World {{ world.name }} <span class="small">#{{ world.wid }}</span></p>

          <button onclick="join()" class="btn btn-danger">Join & merge worlds!</button>
        {% else %}
          <div>
            <p>Pick a city state to play:</p>

            <select id="iso" name="iso" class="form-control">
              {% for town in towns %}
                <option value="{{ town.iso }}">{{ town.name }}</option>
              {% endfor %}
            </select>

            <p>You're about to join World {{ world.name }} <span class="small">#{{ world.wid }}</span></p>

            <button onclick="join($('#iso').value)" class="btn btn-danger">Join world!</button>
          </div>
        {% endif %}


      </div>
    </div>
  </div>

  <script type="text/javascript">
    function join(iso) {
      let formData = new FormData();

      formData.append('iso', iso);

      fetch('/api/worlds/join/{{ world.wid }}', {
        method: 'PATCH',
        body: formData
      }).then(resp=> resp.json() ).then((resp)=>{
        if (resp.err) {
          if (resp.err == 'cant_merge')
            $("#merge_err").innerHTML = "You can't join this world, because players are already playing the following cities there: " + str(resp.names);
          else {
            alert("Can't join world: " + resp.err);
            console.error(resp);
          }
        } else {
          window.location = '/world';
        }
      });
    }
  </script>
{% endblock %}